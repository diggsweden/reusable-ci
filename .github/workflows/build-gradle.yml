# SPDX-FileCopyrightText: 2025 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0
# Gradle Builder
# 
# Purpose: Builds Gradle projects (Android/JVM) and uploads artifacts for subsequent
# publishing steps. Separates build logic from registry-specific publishing.
#
# Build Process:
#   1. Set up JDK and Android SDK (if needed)
#   2. Run Gradle build tasks
#   3. Optional: Sign Android APK/AAB
#   4. Upload built artifacts
#
# Outputs:
#   - Artifacts uploaded as 'gradle-build-artifacts' for use by publish-* workflows
#
# Required Permissions:
#   contents: read  # Checkout code
#
name: Build Gradle Project
on:
  workflow_call:
    inputs:
      build-type:
        description: "Build type: app (application) or plugin (Gradle plugin)"
        required: false
        default: "app"
        type: string
      java-version:
        description: "Java version"
        required: true
        type: string
      working-directory:
        description: "Working directory"
        required: false
        default: "."
        type: string
      gradle-tasks:
        description: "Gradle tasks to run"
        required: false
        default: "assemble"
        type: string
      build-module:
        description: "Gradle module to build"
        required: false
        default: "app"
        type: string
      enable-signing:
        description: "Enable Android app signing"
        required: false
        default: false
        type: boolean
      skip-tests:
        description: "Skip tests during build"
        required: false
        default: false
        type: boolean
      branch:
        description: "Branch to checkout"
        required: false
        default: "main"
        type: string
permissions:
  contents: read
jobs:
  build-gradle:
    name: Build Gradle Project
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 1
      - name: Set up JDK
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: 'temurin'
          java-version: ${{ inputs['java-version'] }}
          cache: 'gradle'
      - name: Set up Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2
      - name: Make gradlew executable
        working-directory: ${{ inputs['working-directory'] }}
        run: chmod +x ./gradlew
      - name: Decode Android keystore
        if: ${{ inputs['enable-signing'] }}
        working-directory: ${{ inputs['working-directory'] }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE }}
        run: |
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            printf "%s" "$ANDROID_KEYSTORE_BASE64" | base64 -d > release.keystore
            printf "âœ“ Android keystore decoded successfully\n"
          else
            printf "::error::ANDROID_KEYSTORE secret not found but enableSigning is true\n"
            exit 1
          fi
      - name: Get version info
        id: version-info
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          if [ -f "gradle.properties" ]; then
            VERSION=$(grep "versionName=" gradle.properties | cut -d'=' -f2)
            VERSION_CODE=$(grep "versionCode=" gradle.properties | cut -d'=' -f2)
            printf "VERSION=%s\n" "${VERSION}" >> "$GITHUB_OUTPUT"
            printf "VERSION_CODE=%s\n" "${VERSION_CODE}" >> "$GITHUB_OUTPUT"
            printf "Version: %s (%s)\n" "${VERSION}" "${VERSION_CODE}"
          else
            printf "::warning::gradle.properties not found, version info unavailable\n"
          fi
      - name: Run Gradle build
        working-directory: ${{ inputs['working-directory'] }}
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          printf "Running Gradle tasks: %s\n" "${{ inputs['gradle-tasks'] }}"
          if [ "${{ inputs['skip-tests'] }}" = "true" ]; then
            ./gradlew ${{ inputs['gradle-tasks'] }} -x test
          else
            ./gradlew ${{ inputs['gradle-tasks'] }}
          fi
      - name: List built artifacts
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          printf "Built artifacts:\n"
          find ${{ inputs['build-module'] }}/build/outputs -type f \( -name "*.apk" -o -name "*.aab" -o -name "*.jar" \) -ls || printf "No artifacts found\n"
      - name: Upload Gradle artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: gradle-build-artifacts
          path: |
            ${{ inputs['working-directory'] }}/${{ inputs['build-module'] }}/build/outputs/**/*.apk
            ${{ inputs['working-directory'] }}/${{ inputs['build-module'] }}/build/outputs/**/*.aab
            ${{ inputs['working-directory'] }}/${{ inputs['build-module'] }}/build/libs/*.jar
          retention-days: 7
          if-no-files-found: error
      - name: Generate build summary
        run: |
          {
            printf "## Gradle Build Summary ðŸ”¨\n"
            printf "\n"
            printf "%s **Java:** %s\n" "-" "${{ inputs['java-version'] }}"
            printf "%s **Module:** %s\n" "-" "${{ inputs['build-module'] }}"
            printf "%s **Tasks:** %s\n" "-" "${{ inputs['gradle-tasks'] }}"

            if [ "${{ inputs['skip-tests'] }}" = "true" ]; then
              printf "%s **Tests:** %s\n" "-" "âŠ˜ Skipped"
            else
              printf "%s **Tests:** %s\n" "-" "âœ“ Executed"
            fi

            if [ "${{ inputs['enable-signing'] }}" = "true" ]; then
              printf "%s **Signing:** %s\n" "-" "âœ“ Enabled"
            else
              printf "%s **Signing:** %s\n" "-" "âŠ˜ Disabled"
            fi

            if [ -n "${{ steps.version-info.outputs.VERSION }}" ]; then
              printf "%s **Version:** %s (%s)\n" "-" "${{ steps.version-info.outputs.VERSION }}" "${{ steps.version-info.outputs.VERSION_CODE }}"
            fi

            printf "\n"
            printf "*Build completed at %s*\n" "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          } >> "$GITHUB_STEP_SUMMARY"
