# SPDX-FileCopyrightText: 2025 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0
# Maven Builder
# 
# Purpose: Builds Maven projects (applications or libraries) and uploads artifacts
# for subsequent publishing steps. Separates build logic from registry-specific publishing.
#
# Build Types:
#   - app: Standard application JAR (no sources/javadoc)
#   - lib: Library with sources and javadoc JARs (required for Maven Central)
#
# Outputs:
#   - Artifacts uploaded as 'maven-build-artifacts' for use by publish-* workflows
#
# Required Permissions:
#   contents: read  # Checkout code
#
name: Build Maven Project
on:
  workflow_call:
    inputs:
      build-type:
        description: "Build type: app (application) or lib (library with sources/javadoc)"
        required: true
        type: string
      java-version:
        description: "Java version"
        required: true
        type: string
      working-directory:
        description: "Working directory"
        required: false
        default: "."
        type: string
      skip-tests:
        description: "Skip tests during build"
        required: false
        default: false
        type: boolean
      branch:
        description: "Branch to checkout"
        required: false
        default: "main"
        type: string
      profile:
        description: "Maven profile to activate (e.g., central-release for libraries)"
        required: false
        default: ""
        type: string
permissions:
  contents: read
env:
  MAVEN_CLI_OPTS: "--batch-mode --no-transfer-progress --errors --fail-at-end -Dstyle.color=always"
jobs:
  build-maven:
    name: Build Maven Project
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 1
      - name: Set up JDK
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          java-version: ${{ inputs['java-version'] }}
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: ${{ inputs['working-directory'] }}/pom.xml
      - name: Install dependencies for multi-module projects
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          printf "Installing project modules to local repository...\n"
          # shellcheck disable=SC2086
          mvn $MAVEN_CLI_OPTS install -DskipTests
      - name: Get version info
        id: version-info
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          printf "VERSION=%s\n" "${VERSION}" >> "$GITHUB_OUTPUT"

          if [[ "${VERSION}" == *-SNAPSHOT ]]; then
            printf "IS_SNAPSHOT=true\n" >> "$GITHUB_OUTPUT"
          else
            printf "IS_SNAPSHOT=false\n" >> "$GITHUB_OUTPUT"
          fi

          GROUP_ID=$(mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout)
          ARTIFACT_ID=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
          printf "GROUP_ID=%s\n" "${GROUP_ID}" >> "$GITHUB_OUTPUT"
          printf "ARTIFACT_ID=%s\n" "${ARTIFACT_ID}" >> "$GITHUB_OUTPUT"

          printf "Project: %s:%s:%s\n" "${GROUP_ID}" "${ARTIFACT_ID}" "${VERSION}"
      - name: Build application
        if: ${{ inputs['build-type'] == 'app' }}
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          printf "Building Maven application...\n"
          # shellcheck disable=SC2086
          if [ "${{ inputs['skip-tests'] }}" = "true" ]; then
            mvn $MAVEN_CLI_OPTS clean package -DskipTests
          else
            mvn $MAVEN_CLI_OPTS clean package
          fi
      - name: Build library with sources and javadoc
        if: ${{ inputs['build-type'] == 'lib' }}
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          printf "Building Maven library with sources and javadoc...\n"

          # Determine profile argument
          PROFILE_ARG=""
          if [ -n "${{ inputs['profile'] }}" ]; then
            PROFILE_ARG="-P${{ inputs['profile'] }}"
            printf "Using Maven profile: %s\n" "${{ inputs['profile'] }}"
          fi

          # shellcheck disable=SC2086
          mvn $MAVEN_CLI_OPTS clean compile $PROFILE_ARG

          if [ "${{ inputs['skip-tests'] }}" != "true" ]; then
            printf "Running tests...\n"
            # shellcheck disable=SC2086
            mvn $MAVEN_CLI_OPTS test $PROFILE_ARG
          fi

          printf "Creating library package with sources and javadoc...\n"
          # Skip GPG signing during build (will be done during publish)
          # shellcheck disable=SC2086
          mvn $MAVEN_CLI_OPTS package -DskipTests=${{ inputs['skip-tests'] }} $PROFILE_ARG -Dgpg.skip=true
      - name: List built artifacts
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          printf "Built artifacts:\n"
          ls -lh target/*.jar 2>/dev/null || printf "No JAR files in root target/\n"
          ls -lh target/*.war 2>/dev/null || printf "No WAR files in root target/\n"

          printf "Checking for multi-module artifacts:\n"
          find . -type f -name "*.jar" -path "*/target/*" ! -name "original-*.jar" -exec ls -lh {} \; 2>/dev/null || printf "No JAR files found in sub-modules\n"
      - name: Upload Maven artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: maven-build-artifacts
          path: |
            ${{ inputs['working-directory'] }}/target/*.jar
            ${{ inputs['working-directory'] }}/target/*.war
            ${{ inputs['working-directory'] }}/target/*.pom
            ${{ inputs['working-directory'] }}/**/target/*.jar
            ${{ inputs['working-directory'] }}/**/target/*.war
            ${{ inputs['working-directory'] }}/**/target/*.pom
            !${{ inputs['working-directory'] }}/target/original-*.jar
            !${{ inputs['working-directory'] }}/**/target/original-*.jar
          retention-days: 7
          if-no-files-found: warn
      - name: Generate build summary
        run: |
          {
            printf "## Maven Build Summary ðŸ”¨\n"
            printf "\n"
            printf "%s **Type:** %s\n" "-" "${{ inputs['build-type'] }}"
            printf "%s **Artifact:** \`%s:%s:%s\`\n" "-" "${{ steps.version-info.outputs.GROUP_ID }}" "${{ steps.version-info.outputs.ARTIFACT_ID }}" "${{ steps.version-info.outputs.VERSION }}"
            printf "%s **Java:** %s\n" "-" "${{ inputs['java-version'] }}"

            if [ "${{ inputs['skip-tests'] }}" = "true" ]; then
              printf "%s **Tests:** %s\n" "-" "âŠ˜ Skipped"
            else
              printf "%s **Tests:** %s\n" "-" "âœ“ Executed"
            fi

            printf "%s **Snapshot:** %s\n" "-" "${{ steps.version-info.outputs.IS_SNAPSHOT }}"
            printf "\n"
            printf "*Build completed at %s*\n" "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          } >> "$GITHUB_STEP_SUMMARY"
