# SPDX-FileCopyrightText: 2025 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0
# NPM Builder
# 
# Purpose: Builds NPM projects and uploads artifacts for subsequent publishing steps.
# Separates build logic from registry-specific publishing.
#
# Build Process:
#   1. Install dependencies (npm ci)
#   2. Run tests (if configured)
#   3. Build application (if build script exists)
#   4. Upload built artifacts
#
# Outputs:
#   - Artifacts uploaded as 'npm-build-artifacts' for use by publish-* workflows
#
# Required Permissions:
#   contents: read  # Checkout code
#
name: Build NPM Project
on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: true
        type: string
      working-directory:
        description: "Working directory"
        required: false
        default: "."
        type: string
      skip-tests:
        description: "Skip tests during build"
        required: false
        default: false
        type: boolean
      branch:
        description: "Branch to checkout"
        required: false
        default: "main"
        type: string
permissions:
  contents: read
jobs:
  build-npm:
    name: Build NPM Project
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 1
      - name: Set up Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ inputs['node-version'] }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs['working-directory'] }}/package-lock.json
      - name: Get version info
        id: version-info
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          NAME=$(node -p "require('./package.json').name")
          printf "VERSION=%s\n" "${VERSION}" >> "$GITHUB_OUTPUT"
          printf "NAME=%s\n" "${NAME}" >> "$GITHUB_OUTPUT"
          printf "Package: %s@%s\n" "${NAME}" "${VERSION}"
      - name: Install dependencies
        working-directory: ${{ inputs['working-directory'] }}
        run: npm ci
      - name: Run tests
        if: ${{ !inputs['skip-tests'] }}
        working-directory: ${{ inputs['working-directory'] }}
        run: npm test || printf "::warning::No tests configured\n"
      - name: Build application
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          if grep -q '"build"' package.json; then
            printf "Running build script...\n"
            npm run build
          else
            printf "No build script found, skipping build step\n"
          fi
      - name: List built artifacts
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          printf "Package contents:\n"
          if [ -d "dist" ]; then
            printf "dist/ directory:\n"
            ls -lh dist/ || true
          fi
          if [ -d "build" ]; then
            printf "build/ directory:\n"
            ls -lh build/ || true
          fi
      - name: Pack NPM tarball
        id: pack
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          TARBALL=$(npm pack 2>&1 | tail -n 1)
          printf "tarball=%s\n" "$TARBALL" >> "$GITHUB_OUTPUT"
          printf "Created tarball: %s\n" "$TARBALL"
          ls -lh "$TARBALL"
      - name: Upload NPM artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: npm-build-artifacts
          path: ${{ inputs['working-directory'] }}/${{ steps.pack.outputs.tarball }}
          retention-days: 7
          if-no-files-found: error
      - name: Generate build summary
        run: |
          {
            printf "## NPM Build Summary ðŸ”¨\n"
            printf "\n"
            printf "%s **Package:** \`%s@%s\`\n" "-" "${{ steps.version-info.outputs.NAME }}" "${{ steps.version-info.outputs.VERSION }}"
            printf "%s **Node.js:** %s\n" "-" "${{ inputs['node-version'] }}"

            if [ "${{ inputs['skip-tests'] }}" = "true" ]; then
              printf "%s **Tests:** %s\n" "-" "âŠ˜ Skipped"
            else
              printf "%s **Tests:** %s\n" "-" "âœ“ Executed"
            fi

            printf "\n"
            printf "*Build completed at %s*\n" "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          } >> "$GITHUB_STEP_SUMMARY"
