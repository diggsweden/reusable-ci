# SPDX-FileCopyrightText: 2025 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0
# Description:
# This workflow runs quality checks using devbase-check, providing a unified
# linting experience between local development and CI.
#
# Features:
# - Uses the same verify.sh script locally and in CI
# - Client justfile overrides (e.g., lint-license: @echo "Skipping") work in CI
# - Generates GitHub Actions summary with pass/fail per linter
# - Version-pinned devbase-check with Renovate auto-updates
#
# How to use:
# 1. Ensure your project has:
#    - .mise.toml with required tools
#    - justfile with lint-* tasks (using devbase-check)
#
# 2. Add to your workflow file:
#    jobs:
#      devbase-check-lint:
#        uses: <orgname>/<reponame>/.github/workflows/lint-devbase-check.yml@main
name: Quality Checks (devbase-check)
env:
  # renovate: datasource=github-releases depName=diggsweden/devbase-check
  DEVBASE_CHECK_VERSION: "v0.4.0"
  # renovate: datasource=github-releases depName=casey/just
  JUST_VERSION: "1.43.0"
  JUST_CHECKSUM: "a1bc93654f31669fd964ea3011a5e5e9676b9b6f8adcd762606e5140632ea72d"
  # renovate: datasource=github-releases depName=jdx/mise
  MISE_VERSION: "2025.12.12"
  MISE_CHECKSUM: "d300a395d82092a4793c9d02a4fff15819ace22a027ddc58a83602aea24ee646"
on:
  workflow_call: # yamllint disable-line rule:truthy
    inputs:
      devbase-check-version:
        description: "Override devbase-check version (default: pinned version)"
        required: false
        default: ""
        type: string
permissions:
  contents: read
jobs:
  devbase-check-lint:
    name: Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Fetch base branch for PR
        if: github.event_name == 'pull_request'
        run: git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
      - name: Install just command runner
        run: |
          # Install pinned version of just for reproducible builds
          cd /tmp
          curl -sSfL "https://github.com/casey/just/releases/download/${JUST_VERSION}/just-${JUST_VERSION}-x86_64-unknown-linux-musl.tar.gz" -o just.tar.gz
          # Verify checksum for security
          printf "%s  just.tar.gz" "${JUST_CHECKSUM}" | sha256sum -c
          tar -xzf just.tar.gz
          sudo mv just /usr/local/bin/just
          chmod +x /usr/local/bin/just
          rm just.tar.gz
          just --version
      - name: Install mise
        run: |
          # Install pinned version of mise for reproducible builds
          cd /tmp
          curl -sSfL "https://github.com/jdx/mise/releases/download/v${MISE_VERSION}/mise-v${MISE_VERSION}-linux-x64-musl.tar.gz" -o mise.tar.gz
          # Verify checksum for security
          printf "%s  mise.tar.gz" "${MISE_CHECKSUM}" | sha256sum -c
          tar -xzf mise.tar.gz
          sudo mv mise/bin/mise /usr/local/bin/mise
          chmod +x /usr/local/bin/mise
          rm -rf mise.tar.gz mise
          mise --version
      - name: Cache mise tools
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.local/share/mise
          key: mise-${{ env.MISE_VERSION }}-${{ runner.os }}-${{ hashFiles('.mise.toml') }}
          restore-keys: |
            mise-${{ env.MISE_VERSION }}-${{ runner.os }}-
      - name: Install devbase-check
        env:
          VERSION: ${{ inputs.devbase-check-version || env.DEVBASE_CHECK_VERSION }}
        run: |
          git clone --depth 1 --branch "${VERSION}" \
            https://github.com/diggsweden/devbase-check \
            ~/.local/share/devbase-check
          printf "Installed devbase-check %s\n" "${VERSION}"
      - name: Install development tools
        env:
          MISE_GITHUB_TOKEN: ${{ github.token }}
        run: |
          mise trust
          just install
      - name: Run linting
        run: |
          eval "$(mise activate bash)"
          just verify
