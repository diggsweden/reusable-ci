# SPDX-FileCopyrightText: 2025 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0
# Maven Central Publisher
# 
# Purpose: Publishes Maven library artifacts to Maven Central (Sonatype OSSRH) repository.
# Downloads pre-built artifacts from workflow artifacts (must include sources and javadoc JARs)
# and deploys them to Maven Central with GPG signing.
#
# Requirements:
#   - Artifacts must be built with build-maven.yml using build-type: lib
#   - POM must have required Maven Central metadata (name, description, url, licenses, etc.)
#   - GPG signing credentials configured
#   - Maven Central (Sonatype) credentials configured
#
# Required Secrets:
#   MAVENCENTRAL_USERNAME: Sonatype OSSRH username
#   MAVENCENTRAL_PASSWORD: Sonatype OSSRH password or token
#   OSPO_BOT_GPG_PRIV: GPG private key for signing
#   OSPO_BOT_GPG_PASS: GPG key passphrase
#
# Required Permissions:
#   contents: read   # Download artifacts
#   packages: write  # Backup publish to GitHub Packages
#
name: Publish to Maven Central
on:
  workflow_call:
    inputs:
      artifact-source:
        description: "Name of workflow artifact containing built library JARs"
        required: true
        type: string
      java-version:
        description: "Java version"
        required: false
        default: "25"
        type: string
      working-directory:
        description: "Working directory"
        required: false
        default: "."
        type: string
      settings-path:
        description: "Path to Maven settings.xml (optional)"
        required: false
        type: string
      profile:
        description: "Maven profile to use for deployment"
        required: false
        default: "central-release"
        type: string
      branch:
        description: "Branch to checkout (default: main)"
        required: false
        default: "main"
        type: string
permissions:
  contents: read
env:
  MAVEN_CLI_OPTS: "--batch-mode --no-transfer-progress --errors --fail-at-end -Dstyle.color=always"
jobs:
  publish-maven-central:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          ref: ${{ inputs.branch }}
      - name: Set up JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: ${{ inputs['java-version'] }}
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: ${{ inputs['working-directory'] }}/pom.xml
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.OSPO_BOT_GPG_PRIV }}
          passphrase: ${{ secrets.OSPO_BOT_GPG_PASS }}
      - name: Download build artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: ${{ inputs['artifact-source'] }}
          path: ${{ inputs['working-directory'] }}/
      - name: Verify artifacts for Maven Central
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          printf "Checking for required artifacts...\n"

          # Maven Central requires: main JAR, sources JAR, javadoc JAR, POM
          # Check in all target directories (supports multi-module projects)
          SOURCES_COUNT=$(find . -type f -name "*-sources.jar" -path "*/target/*" | wc -l)
          JAVADOC_COUNT=$(find . -type f -name "*-javadoc.jar" -path "*/target/*" | wc -l)

          if [ "$SOURCES_COUNT" -eq 0 ]; then
            printf "::error::Missing sources JAR. Maven Central requires sources.\n"
            printf "::error::Build with build-type: lib to generate sources and javadoc JARs\n"
            exit 1
          fi

          if [ "$JAVADOC_COUNT" -eq 0 ]; then
            printf "::error::Missing javadoc JAR. Maven Central requires javadoc.\n"
            printf "::error::Build with build-type: lib to generate sources and javadoc JARs\n"
            exit 1
          fi

          printf "âœ“ All required artifacts present:\n"
          printf "  - Sources JARs: %s\n" "$SOURCES_COUNT"
          printf "  - Javadoc JARs: %s\n" "$JAVADOC_COUNT"
          find . -type f -name "*.jar" -path "*/target/*" ! -name "original-*.jar" -exec ls -lh {} \;
      - name: Get version info
        id: version-info
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          printf "VERSION=%s\n" "${VERSION}" >> "$GITHUB_OUTPUT"

          if [[ "${VERSION}" == *-SNAPSHOT ]]; then
            printf "IS_SNAPSHOT=true\n" >> "$GITHUB_OUTPUT"
          else
            printf "IS_SNAPSHOT=false\n" >> "$GITHUB_OUTPUT"
          fi

          printf "Project version: %s\n" "${VERSION}"
      - name: Deploy to Maven Central
        working-directory: ${{ inputs['working-directory'] }}
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVENCENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVENCENTRAL_PASSWORD }}
        run: |
          printf "Deploying to Maven Central...\n"

          # Use settings file if provided
          SETTINGS_ARG=""
          SETTINGS_PATH="${{ inputs['settings-path'] }}"
          if [ -n "${SETTINGS_PATH}" ]; then
            if [ -f "${SETTINGS_PATH}" ]; then
              SETTINGS_ARG="--settings ${SETTINGS_PATH}"
              printf "Using settings file: %s\n" "${SETTINGS_PATH}"
            else
              printf "::error::Settings file specified but not found: %s\n" "${SETTINGS_PATH}"
              exit 1
            fi
          fi

          # Deploy with profile (includes GPG signing via maven-gpg-plugin)
          # shellcheck disable=SC2086
          mvn $MAVEN_CLI_OPTS deploy $SETTINGS_ARG -P${{ inputs.profile }} -DskipTests
      - name: Generate publish summary
        run: |
          {
            printf "## Published to Maven Central ðŸš€\n"
            printf "\n"
            printf "%s **Version:** %s\n" "-" "${{ steps.version-info.outputs.VERSION }}"

            if [ "${{ steps.version-info.outputs.IS_SNAPSHOT }}" = "true" ]; then
              printf "%s **Type:** %s\n" "-" "SNAPSHOT"
            else
              printf "%s **Type:** %s\n" "-" "Release"
            fi

            printf "%s **Registry:** [Maven Central](https://central.sonatype.com/)\n" "-"
            printf "\n"

            if [ "${{ steps.version-info.outputs.IS_SNAPSHOT }}" = "true" ]; then
              printf "âš ï¸ **SNAPSHOT** releases are available immediately in the snapshot repository.\n"
            else
              printf "âœ“ **Release** deployed to staging. Will be published to Central within 30 minutes.\n"
            fi

            printf "\n"
            printf "*Published at %s*\n" "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          } >> "$GITHUB_STEP_SUMMARY"
