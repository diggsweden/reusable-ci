# SPDX-FileCopyrightText: 2025 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0
# Development NPM Package Publisher
# 
# Purpose: Publishes pre-built npm packages for development and testing.
#
# Supported Registries:
# - GitHub Packages (npm.pkg.github.com) - Default, uses GITHUB_TOKEN
# - npmjs.org - Set use-github-token=false, provide registry-password
# - Any custom npm registry
#
# How it works:
# 1. Downloads pre-built artifacts from build-npm.yml
# 2. Generates dev version: ${BASE_VERSION}-dev-${BRANCH}-${SHORT_SHA}
# 3. Applies version to package.json (no git commit)
# 4. Creates npm pack tarball
# 5. Publishes to registry with 'dev' tag
# 6. Uploads tarball as workflow artifact
#
# Security controls:
# - Minimal - optimized for speed
# - Packages tagged with 'dev' not 'latest'
# - No SBOM, no signing, no attestation
#
# Dependencies:
# - Requires build-npm.yml to have run first
# - Downloads npm-build-artifacts
#
# Registry Authentication:
#   GitHub Packages (default): Uses GITHUB_TOKEN (no secrets needed)
#   Other registries: Set use-github-token=false and provide registry-password secret
#
# Required Secrets:
#   registry-password: Required when use-github-token=false (for npmjs.org, etc)
#
# Required Permissions:
#   contents: read
#   packages: write  # Only if publishing to GitHub Packages
#
# Outputs:
#   package-name: Published package name
#   package-version: Published dev version
#   tarball: Tarball filename
name: Publish Dev NPM Package
on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: false
        default: "24"
        type: string
      working-directory:
        description: "Working directory"
        required: false
        default: "."
        type: string
      registry:
        description: "NPM registry URL"
        required: false
        default: "https://npm.pkg.github.com"
        type: string
      package-scope:
        description: "Required package scope (e.g., @diggsweden). Leave empty to skip validation."
        required: false
        default: ""
        type: string
      registry-username:
        description: "NPM registry username (defaults to github.actor for GitHub Packages)"
        required: false
        type: string
      use-github-token:
        description: "Use GITHUB_TOKEN for authentication (GitHub Packages only)"
        required: false
        default: true
        type: boolean
      reusable-ci-ref:
        description: "Ref for reusable-ci scripts checkout (for testing feature branches)"
        required: false
        default: "main"
        type: string
    secrets:
      registry-password:
        description: "NPM registry auth token (required when use-github-token=false)"
        required: false
    outputs:
      package-name:
        description: "Published package name"
        value: ${{ jobs.build-and-publish.outputs.package-name }}
      package-version:
        description: "Published dev version"
        value: ${{ jobs.build-and-publish.outputs.package-version }}
      tarball:
        description: "Tarball filename"
        value: ${{ jobs.build-and-publish.outputs.tarball }}
permissions:
  contents: read
jobs:
  build-and-publish:
    name: Build & Publish Dev NPM Package
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write
    outputs:
      package-name: ${{ steps.meta.outputs.name }}
      package-version: ${{ steps.tags.outputs.dev_version }}
      tarball: ${{ steps.pack.outputs.tarball }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: ${{ inputs.registry }}
          cache: npm
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json
      - name: Read package metadata
        id: meta
        working-directory: ${{ inputs.working-directory }}
        run: |
          NAME=$(node -p "require('./package.json').name")
          printf "name=%s\n" "$NAME" >> "$GITHUB_OUTPUT"
          printf "Package name: %s\n" "$NAME"
      - name: Validate package scope
        if: ${{ inputs.package-scope != '' }}
        working-directory: ${{ inputs.working-directory }}
        run: |
          NAME=$(node -p "require('./package.json').name")
          SCOPE="${{ inputs.package-scope }}"
          if [[ "$NAME" != ${SCOPE}/* ]]; then
            printf "::error::package.json name must be scoped as %s/<pkg>\n" "${SCOPE}"
            printf "Found: %s\n" "$NAME"
            exit 1
          fi
          # Configure scoped registry
          SCOPE_NAME="${SCOPE#@}"
          npm config set "${SCOPE}:registry" "${{ inputs.registry }}"
      - name: Download NPM build artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: npm-build-artifacts
          path: ${{ inputs.working-directory }}/dist/
      - name: Checkout .github repository for scripts
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          repository: diggsweden/reusable-ci
          ref: ${{ inputs.reusable-ci-ref }}
          path: .github-shared
          sparse-checkout: scripts
      - name: Check registry authentication configuration
        run: |
          HAS_PASSWORD="false"
          if [ -n "${{ secrets['registry-password'] }}" ]; then
            HAS_PASSWORD="true"
          fi

          bash .github-shared/scripts/registry/validate-auth.sh \
            "${{ inputs['use-github-token'] }}" \
            "${{ inputs.registry }}" \
            "https://npm.pkg.github.com" \
            "$HAS_PASSWORD"
      - name: Generate dev version tag
        id: tags
        shell: bash
        run: |
          DEV_VERSION=$(bash .github-shared/scripts/version/generate-dev-version.sh)
          printf "dev_version=%s\n" "${DEV_VERSION}" >> "$GITHUB_OUTPUT"
          printf "ðŸ“¦ Dev version: %s\n" "${DEV_VERSION}"
      - name: Apply dev version to package.json
        working-directory: ${{ inputs.working-directory }}
        env:
          DEV_VERSION: ${{ steps.tags.outputs.dev_version }}
        run: |
          npm version "$DEV_VERSION" --no-git-tag-version --allow-same-version
          printf "Applied version: %s\n" "$(node -p "require('./package.json').version")"
      - name: Pack tarball
        id: pack
        working-directory: ${{ inputs.working-directory }}
        run: |
          FILE=$(npm pack --silent)
          printf "tarball=%s\n" "$FILE" >> "$GITHUB_OUTPUT"
          printf "Created: %s\n" "$FILE"
      - name: Upload tarball as artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: npm-dev-package-${{ github.run_id }}
          path: ${{ inputs.working-directory }}/${{ steps.pack.outputs.tarball }}
          retention-days: 7
      - name: Publish to NPM registry
        working-directory: ${{ inputs.working-directory }}
        env:
          NODE_AUTH_TOKEN: ${{ inputs['use-github-token'] && secrets.GITHUB_TOKEN || secrets['registry-password'] }}
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")
          printf "Publishing %s@%s to %s with tag 'dev'\n" "${PKG_NAME}" "${PKG_VERSION}" "${{ inputs.registry }}"
          npm publish --tag dev
          printf "âœ… Published successfully\n"
