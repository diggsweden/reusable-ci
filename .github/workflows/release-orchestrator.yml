# SPDX-FileCopyrightText: 2025 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0
# Release Orchestrator
# 
# Purpose: Main orchestrator workflow that coordinates the complete release process for
# production releases. It handles version management, artifact publishing, container 
# building, security attestations, and GitHub release creation in a single workflow.
#
# How it works:
# 1. Validates release prerequisites (version match, credentials, permissions)
# 2. Bumps version and generates changelog using git-cliff
# 3. Publishes artifacts to configured registries (Maven Central, NPM, GitHub Packages)
# 4. Builds and publishes container images with SLSA/SBOM if configured
# 5. Creates GitHub release with changelog, artifacts, and signatures
#
# Security controls:
# - GPG signing of all artifacts (if signatures: true)
# - SLSA provenance attestation for supply chain security
# - SBOM generation in multiple formats (CycloneDX, SPDX)
# - Container vulnerability scanning with Trivy
# - License compliance checking
#
# Required Secrets (depending on configuration):
#   GITHUB_TOKEN: Automatically provided for GitHub operations
#   GPG_SECRET_KEY: For artifact signing (if signatures enabled)
#   GPG_PASSPHRASE: For artifact signing (if signatures enabled)
#   MAVEN_CENTRAL_USERNAME: For Maven Central publishing (when publish-to includes maven-central)
#   MAVEN_CENTRAL_PASSWORD: For Maven Central publishing (when publish-to includes maven-central)
#   NPM_TOKEN: For NPM registry publishing (npm packages)
#
# Required Permissions:
#   contents: write       # Create releases and tags
#   packages: write       # Publish packages and containers
#   id-token: write      # OIDC for attestations
#   attestations: write  # Attach SBOMs
#   security-events: write # Upload scan results
#   actions: read        # Read workflow for SLSA
#
# v3 Design
# - Removed single-artifact inline mode
# - Only supports artifactsConfig file
# - Separate artifacts[] and containers[] sections
# - Container configuration moved to containers[] section
#
# Build Types: application (default), library
# Publishing: Controlled via build-type, require-authorization, publish-to fields
# Containers: Separate section with explicit dependencies
name: Release Orchestrator
on:
  workflow_call: # yamllint disable-line rule:truthy
    inputs:
      # === REQUIRED: artifacts.yml FILE ===
      artifacts-config:
        description: "Path to artifacts config file (required, e.g., .github/artifacts.yml)"
        required: true
        type: string
      # === SHARED CONFIGURATION ===
      release-type:
        description: "Release type: stable, prerelease (auto-detected from tag if not specified)"
        required: false
        type: string
      branch:
        description: "Branch to work with (default: main)"
        required: false
        default: "main"
        type: string
      # Changelog creator configuration
      changelog-creator:
        description: "Changelog creator type (e.g., git-cliff). Leave empty to skip"
        required: false
        default: "git-cliff"
        type: string
      changelog.config:
        description: "Changelog configuration file (default: uses generate-changelog default)"
        required: false
        default: ""
        type: string
      changelog.skipversionbump:
        description: "Skip version bump (default: false)"
        required: false
        default: false
        type: boolean
      # Release publisher configuration  
      release-publisher:
        description: "Release publisher type (github-cli). Leave empty to skip GitHub release"
        required: false
        type: string
      release.generatesbom:
        description: "Generate SBOM for release (default: true)"
        required: false
        default: true
        type: boolean
      release.attachartifacts:
        description: "Glob patterns for artifacts to attach to GitHub release (comma/newline separated)"
        required: false
        default: ""
        type: string
      release.signartifacts:
        description: "GPG sign release artifacts (default: true)"
        required: false
        default: true
        type: boolean
      release.checkauthorization:
        description: "Check if user is authorized for non-SNAPSHOT releases"
        required: false
        default: false
        type: boolean
        # Note: Typically set to true for public libraries publishing to Maven Central
      release.draft:
        description: "Create as draft release (default: false)"
        required: false
        default: false
        type: boolean
      # Advanced configuration
      working-directory:
        description: "Working directory for operations"
        required: false
        default: "."
        type: string
      file-pattern:
        description: "Files to commit in version bump (auto-detected by project type if not specified)"
        required: false
        type: string
        default: ""
        # Auto-detected patterns by project type:
        # - Maven: CHANGELOG.md pom.xml
        # - NPM: CHANGELOG.md package.json package-lock.json
        # - Gradle: CHANGELOG.md build.gradle settings.gradle
        # - Gradle Android: CHANGELOG.md build.gradle settings.gradle gradle.properties
        # - Xcode iOS: CHANGELOG.md project.pbxproj
      reusable-ci-ref:
        description: "Ref for reusable-ci scripts checkout (for testing feature branches)"
        required: false
        default: "main"
        type: string
concurrency:
  group: release-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: false # Queue releases, don't cancel partial releases
permissions:
  contents: read # Best Security practice. Jobs only get read as base, and then permissions are added as needed
jobs:
  # Step 0b: Parse Configuration (v3 clean design)
  parse-config:
    name: Parse Configuration
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      artifacts: ${{ steps.parse.outputs.artifacts }}
      containers: ${{ steps.parse.outputs.containers }}
      first-project-type: ${{ steps.parse.outputs.first-project-type }}
      first-build-type: ${{ steps.parse.outputs.first-build-type }}
      first-require-authorization: ${{ steps.parse.outputs.first-require-authorization }}
      # Filtered artifact lists by project type
      maven-artifacts: ${{ steps.parse.outputs.maven-artifacts }}
      npm-artifacts: ${{ steps.parse.outputs.npm-artifacts }}
      gradle-artifacts: ${{ steps.parse.outputs.gradle-artifacts }}
      gradleandroid-artifacts: ${{ steps.parse.outputs.gradleandroid-artifacts }}
      xcodeios-artifacts: ${{ steps.parse.outputs.xcodeios-artifacts }}
      python-artifacts: ${{ steps.parse.outputs.python-artifacts }}
      go-artifacts: ${{ steps.parse.outputs.go-artifacts }}
      rust-artifacts: ${{ steps.parse.outputs.rust-artifacts }}
      # Flags indicating presence of each type
      has-maven: ${{ steps.parse.outputs.has-maven }}
      has-npm: ${{ steps.parse.outputs.has-npm }}
      has-gradle: ${{ steps.parse.outputs.has-gradle }}
      has-gradleandroid: ${{ steps.parse.outputs.has-gradleandroid }}
      has-xcodeios: ${{ steps.parse.outputs.has-xcodeios }}
      has-python: ${{ steps.parse.outputs.has-python }}
      has-go: ${{ steps.parse.outputs.has-go }}
      has-rust: ${{ steps.parse.outputs.has-rust }}
      # Filtered by publish target
      mavencentral-artifacts: ${{ steps.parse.outputs.mavencentral-artifacts }}
      githubpackages-artifacts: ${{ steps.parse.outputs.githubpackages-artifacts }}
      has-mavencentral: ${{ steps.parse.outputs.has-mavencentral }}
      has-githubpackages: ${{ steps.parse.outputs.has-githubpackages }}
      is-draft-release: ${{ steps.parse.outputs.is-draft-release }}
      # SBOM generation settings
      needs-sbom: ${{ steps.parse.outputs.needs-sbom }}
      sbom-artifacts: ${{ steps.parse.outputs.sbom-artifacts }}
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          ref: ${{ inputs.branch }}
      - name: Checkout reusable-ci for scripts
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          repository: diggsweden/reusable-ci
          ref: ${{ inputs.reusable-ci-ref }}
          path: .github-shared
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      - name: Parse artifacts.yml
        id: parse
        run: bash .github-shared/scripts/config/parse-artifacts-config.sh
        env:
          ARTIFACTS_CONFIG: ${{ inputs['artifacts-config'] }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
  # Step 0c: Validate configuration
  validate-prerequisites:
    name: Validate Prerequisites
    needs: [parse-config]
    secrets: inherit
    uses: ./.github/workflows/release-prerequisites.yml
    with:
      project-type: ${{ needs.parse-config.outputs.first-project-type }}
      build-type: ${{ needs.parse-config.outputs.first-build-type }}
      container-registry: ghcr.io
      sign-artifacts: ${{ inputs['release.signartifacts'] }}
      check-authorization: ${{ needs.parse-config.outputs.first-require-authorization == 'true' || inputs['release.checkauthorization'] }}
      branch: ${{ inputs.branch }}
      reusable-ci-ref: ${{ inputs.reusable-ci-ref }}
  # Step 1: Version Bump (iterates over all artifacts)
  # File patterns auto-detected in version-bump.yml by scripts/config/get-file-pattern.sh based on project-type
  version-and-changelog:
    needs: [parse-config, validate-prerequisites]
    name: Version Bump - ${{ matrix.artifact.name }}
    if: ${{ !inputs['changelog.skipversionbump'] && inputs['changelog-creator'] == 'git-cliff' }}
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.parse-config.outputs.artifacts) }}
      fail-fast: false
    permissions:
      contents: write
      packages: read
    secrets: inherit
    uses: ./.github/workflows/version-bump.yml
    with:
      branch: ${{ inputs.branch }}
      project-type: ${{ matrix.artifact['project-type'] }}
      file-pattern: ${{ inputs['file-pattern'] }}
      java-version: ${{ matrix.artifact.config['java-version'] }}
      node-version: ${{ matrix.artifact.config['node-version'] }}
      gradle-version-file: ${{ matrix.artifact.config['gradle-version-file'] }}
      working-directory: ${{ matrix.artifact['working-directory'] }}
      reusable-ci-ref: ${{ inputs.reusable-ci-ref }}
  # ===== BUILD PHASE =====
  # NOTE: Build jobs use `if: !failure() && !cancelled() && ...` to run independently.
  # This ensures maven/npm/gradle builds proceed even when other build types are skipped.
  build-maven:
    name: Build Maven - ${{ matrix.artifact.name }}
    needs: [parse-config, version-and-changelog]
    if: ${{ !failure() && !cancelled() && needs.parse-config.outputs.has-maven == 'true' }}
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.parse-config.outputs.maven-artifacts) }}
      fail-fast: false
    permissions:
      contents: read
    secrets: inherit
    uses: ./.github/workflows/build-maven.yml
    with:
      build-type: ${{ matrix.artifact['build-type'] == 'library' && 'lib' || 'app' }}
      java-version: ${{ matrix.artifact.config['java-version'] }}
      working-directory: ${{ matrix.artifact['working-directory'] }}
      branch: ${{ inputs.branch }}
      profile: ${{ matrix.artifact['build-type'] == 'library' && (matrix.artifact.config['maven-profile'] || 'central-release') || '' }}
  # Step 2b: Build NPM artifacts
  build-npm:
    name: Build NPM - ${{ matrix.artifact.name }}
    needs: [parse-config, version-and-changelog]
    if: ${{ !failure() && !cancelled() && needs.parse-config.outputs.has-npm == 'true' }}
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.parse-config.outputs.npm-artifacts) }}
      fail-fast: false
    permissions:
      contents: read
    secrets: inherit
    uses: ./.github/workflows/build-npm.yml
    with:
      node-version: ${{ matrix.artifact.config['node-version'] }}
      working-directory: ${{ matrix.artifact['working-directory'] }}
      branch: ${{ inputs.branch }}
  # Step 2c: Build Gradle artifacts
  build-gradle:
    name: Build Gradle - ${{ matrix.artifact.name }}
    needs: [parse-config, version-and-changelog]
    if: ${{ !failure() && !cancelled() && needs.parse-config.outputs.has-gradle == 'true' }}
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.parse-config.outputs.gradle-artifacts) }}
      fail-fast: false
    permissions:
      contents: read
    secrets: inherit
    uses: ./.github/workflows/build-gradle.yml
    with:
      java-version: ${{ matrix.artifact.config['java-version'] }}
      gradle-tasks: ${{ matrix.artifact.config['gradle-tasks'] }}
      build-module: ${{ matrix.artifact.config['build-module'] }}
      enable-signing: ${{ matrix.artifact.config['enable-android-signing'] }}
      working-directory: ${{ matrix.artifact['working-directory'] }}
      branch: ${{ inputs.branch }}
  # Step 2d: Build Gradle Android artifacts
  build-gradle-android:
    name: Build Gradle Android - ${{ matrix.artifact.name }}
    needs: [parse-config, version-and-changelog]
    if: ${{ !failure() && !cancelled() && needs.parse-config.outputs.has-gradleandroid == 'true' }}
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.parse-config.outputs.gradleandroid-artifacts) }}
      fail-fast: false
    permissions:
      contents: read
    secrets: inherit
    uses: ./.github/workflows/build-gradle.yml
    with:
      java-version: ${{ matrix.artifact.config['java-version'] }}
      gradle-tasks: ${{ matrix.artifact.config['gradle-tasks'] }}
      build-module: ${{ matrix.artifact.config['build-module'] }}
      enable-signing: ${{ matrix.artifact.config['enable-android-signing'] }}
      working-directory: ${{ matrix.artifact['working-directory'] }}
      branch: ${{ inputs.branch }}
  # Step 2e: Build Xcode iOS/macOS artifacts
  build-xcode:
    name: Build Xcode - ${{ matrix.artifact.name }}
    needs: [parse-config, version-and-changelog]
    if: ${{ !failure() && !cancelled() && needs.parse-config.outputs.has-xcodeios == 'true' }}
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.parse-config.outputs.xcodeios-artifacts) }}
      fail-fast: false
    permissions:
      contents: read
    secrets: inherit
    uses: ./.github/workflows/build-xcode-ios.yml
    with:
      xcode-version: ${{ matrix.artifact.config['xcode-version'] }}
      scheme: ${{ matrix.artifact.config['scheme'] }}
      workspace: ${{ matrix.artifact.config['workspace'] }}
      project: ${{ matrix.artifact.config['project'] }}
      configuration: ${{ matrix.artifact.config['configuration'] || 'Release' }}
      enable-code-signing: ${{ matrix.artifact.config['enable-code-signing'] != false }}
      export-options-var: ${{ matrix.artifact.config['export-options-var'] || 'EXPORT_OPTIONS_BASE64' }}
      artifact-name: ${{ matrix.artifact.name }}
      include-tag: false
      working-directory: ${{ matrix.artifact['working-directory'] }}
      macos-version: ${{ matrix.artifact.config['macos-version'] || 'macos-26' }}
      reusable-ci-ref: ${{ inputs.reusable-ci-ref }}
  # Sync point: Wait for all builds to complete before publishing/containers
  await-builds:
    name: Await Builds
    needs: [parse-config, version-and-changelog, build-maven, build-npm, build-gradle, build-gradle-android, build-xcode]
    if: ${{ !failure() && !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: All builds complete
        run: printf "All build jobs have completed successfully\n"
  # Step 3a: Publish to GitHub Packages
  publish-maven-github:
    name: Publish GitHub - ${{ matrix.artifact.name }}
    needs: [parse-config, await-builds]
    if: ${{ !failure() && !cancelled() && needs.parse-config.outputs.has-githubpackages == 'true' }}
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.parse-config.outputs.githubpackages-artifacts) }}
      fail-fast: false
    permissions:
      contents: write
      packages: write
    secrets: inherit
    uses: ./.github/workflows/publish-maven-github.yml
    with:
      artifact-source: ${{ matrix.artifact['project-type'] }}-build-artifacts
      package-type: ${{ matrix.artifact['project-type'] }}
      java-version: ${{ matrix.artifact.config['java-version'] }}
      node-version: ${{ matrix.artifact.config['node-version'] }}
      working-directory: ${{ matrix.artifact['working-directory'] }}
      attach-pattern: ${{ matrix.artifact.config['attach-pattern'] }}
  # Step 3b: Publish to Maven Central
  publish-maven-central:
    name: Publish Maven Central - ${{ matrix.artifact.name }}
    needs: [parse-config, build-maven]
    if: ${{ !failure() && !cancelled() && needs.parse-config.outputs.has-mavencentral == 'true' }}
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.parse-config.outputs.mavencentral-artifacts) }}
      fail-fast: false
    permissions:
      contents: write
      packages: write
      id-token: write
    secrets: inherit
    uses: ./.github/workflows/publish-maven-central.yml
    with:
      artifact-source: maven-build-artifacts
      java-version: ${{ matrix.artifact.config['java-version'] }}
      working-directory: ${{ matrix.artifact['working-directory'] }}
      settings-path: ${{ matrix.artifact.config['settings-path'] }}
      profile: ${{ matrix.artifact.config['profile'] }}
  # Step 3c: Publish to Apple App Store / TestFlight
  publish-apple-appstore:
    name: Publish Apple App Store - ${{ matrix.artifact.name }}
    needs: [parse-config, build-xcode]
    if: ${{ !failure() && !cancelled() && needs.parse-config.outputs.has-xcodeios == 'true' }}
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.parse-config.outputs.xcodeios-artifacts) }}
      fail-fast: false
    permissions:
      contents: read
    secrets: inherit
    uses: ./.github/workflows/publish-apple-appstore.yml
    with:
      ipa-artifact-name: ${{ matrix.artifact.name }}
      working-directory: ${{ matrix.artifact['working-directory'] }}
      macos-version: ${{ matrix.artifact.config['macos-version'] || 'macos-26' }}
      submit-for-review: ${{ matrix.artifact.config['submit-for-review'] || false }}
      skip-validation: ${{ matrix.artifact.config['skip-validation'] || false }}
  # Step 4: Build and Publish Container Images
  build-containers:
    name: Build Container - ${{ matrix.container.name }}
    needs: [parse-config, await-builds]
    if: ${{ !failure() && !cancelled() && needs.parse-config.outputs.containers != '[]' }}
    strategy:
      matrix:
        container: ${{ fromJson(needs.parse-config.outputs.containers) }}
      fail-fast: false
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
      security-events: write
      actions: read
    secrets: inherit
    uses: ./.github/workflows/publish-container.yml
    with:
      container-file: ${{ matrix.container['container-file'] }}
      context: ${{ matrix.container.context || '.' }}
      branch: ${{ inputs.branch }}
      platforms: ${{ matrix.container.platforms || 'linux/amd64,linux/arm64' }}
      enable-slsa: ${{ matrix.container['enable-slsa'] == true || matrix.container['enable-slsa'] == null }}
      enable-sbom: ${{ matrix.container['enable-sbom'] == true || matrix.container['enable-sbom'] == null }}
      enable-scan: ${{ matrix.container['enable-scan'] == true || matrix.container['enable-scan'] == null }}
      registry: ghcr.io
      artifact-types: ${{ join(matrix.container['artifact-types'], ',') }}
      push-image: true
      reusable-ci-ref: ${{ inputs.reusable-ci-ref }}
  # Step 5: Create GitHub Release  
  create-release:
    name: Create GitHub Release
    needs: [parse-config, await-builds, publish-maven-github, publish-maven-central, publish-apple-appstore, build-containers]
    # Run even if previous jobs were skipped but at least one succeeded
    if: ${{ !failure() && !cancelled() && inputs['release-publisher'] == 'github-cli' }}
    permissions:
      contents: write
      packages: read
      id-token: write
    secrets: inherit
    uses: ./.github/workflows/release-github.yml
    with:
      release-name: "${{ github.ref_name }}"
      checkout-ref: ${{ inputs.branch }}
      attach-artifacts: ${{ inputs['release.attachartifacts'] }}
      generate-sbom: ${{ inputs['release.generatesbom'] && needs.parse-config.outputs.needs-sbom == 'true' }}
      sign-artifacts: ${{ inputs['release.signartifacts'] }}
      draft: ${{ inputs['release.draft'] || needs.parse-config.outputs.is-draft-release == 'true' }}
      project-type: ${{ needs.parse-config.outputs.first-project-type }}
      reusable-ci-ref: ${{ inputs.reusable-ci-ref }}
      changelog-config: ${{ inputs['changelog.config'] }}
      make-latest: ${{ (inputs['release-type'] == 'stable' || (!inputs['release-type'] && !contains(github.ref_name, '-'))) && 'true' || 'false' }}
      has-containers: ${{ needs.parse-config.outputs.containers != '[]' }}
  # Final summary
  release-summary:
    name: Release Summary
    needs: [parse-config, version-and-changelog, await-builds, build-maven, build-npm, build-gradle, build-gradle-android, build-xcode, publish-maven-github, publish-maven-central, publish-apple-appstore, build-containers, create-release]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Generate Release Summary
        run: |
          RELEASE_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # Release Summary

          ## Release Overview
          | Property | Value |
          |----------|-------|
          | **Version** | `${{ github.ref_name }}` |
          | **Branch** | `${{ inputs.branch }}` |
          | **Commit** | `${{ github.sha }}` |
          | **Released By** | @${{ github.actor }} |
          EOF

          printf "| **Released At** | %s |\n" "$RELEASE_TIME" >> $GITHUB_STEP_SUMMARY

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ## Job Status
          | Job | Status |
          |-----|--------|
          EOF

          # Version Bump
          if [ "${{ needs.version-and-changelog.result }}" = "success" ]; then
            printf "| Version Bump | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.version-and-changelog.result }}" = "skipped" ]; then
            printf "| Version Bump | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Version Bump | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # Build Maven
          if [ "${{ needs.build-maven.result }}" = "success" ]; then
            printf "| Build Maven | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-maven.result }}" = "skipped" ]; then
            printf "| Build Maven | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Build Maven | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # Build NPM
          if [ "${{ needs.build-npm.result }}" = "success" ]; then
            printf "| Build NPM | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-npm.result }}" = "skipped" ]; then
            printf "| Build NPM | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Build NPM | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # Build Gradle
          if [ "${{ needs.build-gradle.result }}" = "success" ]; then
            printf "| Build Gradle | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-gradle.result }}" = "skipped" ]; then
            printf "| Build Gradle | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Build Gradle | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # Build Gradle Android
          if [ "${{ needs.build-gradle-android.result }}" = "success" ]; then
            printf "| Build Gradle Android | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-gradle-android.result }}" = "skipped" ]; then
            printf "| Build Gradle Android | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Build Gradle Android | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # Build Xcode
          if [ "${{ needs.build-xcode.result }}" = "success" ]; then
            printf "| Build Xcode | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-xcode.result }}" = "skipped" ]; then
            printf "| Build Xcode | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Build Xcode | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # Publish GitHub
          if [ "${{ needs.publish-maven-github.result }}" = "success" ]; then
            printf "| Publish GitHub | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-maven-github.result }}" = "skipped" ]; then
            printf "| Publish GitHub | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Publish GitHub | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # Publish Maven Central
          if [ "${{ needs.publish-maven-central.result }}" = "success" ]; then
            printf "| Publish Maven Central | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-maven-central.result }}" = "skipped" ]; then
            printf "| Publish Maven Central | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Publish Maven Central | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # Publish Apple App Store
          if [ "${{ needs.publish-apple-appstore.result }}" = "success" ]; then
            printf "| Publish Apple App Store | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-apple-appstore.result }}" = "skipped" ]; then
            printf "| Publish Apple App Store | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Publish Apple App Store | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # Containers
          if [ "${{ needs.build-containers.result }}" = "success" ]; then
            printf "| Containers | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-containers.result }}" = "skipped" ]; then
            printf "| Containers | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| Containers | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          # GitHub Release
          if [ "${{ needs.create-release.result }}" = "success" ]; then
            printf "| GitHub Release | %s |\n" "✓" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.create-release.result }}" = "skipped" ]; then
            printf "| GitHub Release | %s |\n" "−" >> $GITHUB_STEP_SUMMARY
          else
            printf "| GitHub Release | %s |\n" "✗" >> $GITHUB_STEP_SUMMARY
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ## Resources
          - [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})
          - [Packages](https://github.com/${{ github.repository }}/packages)
          - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
