# SPDX-FileCopyrightText: 2025 The Reusable CI Authors
#
# SPDX-License-Identifier: CC0-1.0
# Apple App Store / TestFlight Publisher
# 
# Purpose: Publishes iOS applications to Apple App Store Connect (TestFlight) using
# the App Store Connect API.
#
# How it works:
# 1. Downloads IPA artifact from previous build job
# 2. Sets up App Store Connect API authentication
# 3. Validates IPA file
# 4. Uploads to App Store Connect (TestFlight)
# 5. Optionally submits for external testing or review
#
# Features:
#   - TestFlight distribution
#   - App Store Connect API v2 authentication
#   - IPA validation before upload
#   - Configurable submission options
#   - Detailed upload reporting
#
# Outputs:
#   - Upload status and build information
#   - TestFlight availability notifications
#
# Required Secrets:
#   APP_STORE_CONNECT_ISSUER_ID: App Store Connect API issuer ID
#   APP_STORE_CONNECT_API_KEY_ID: App Store Connect API key ID
#   APP_STORE_CONNECT_API_PRIVATE_KEY_BASE64: Base64-encoded API private key (.p8)
#
# Required Permissions:
#   contents: read  # Download artifacts
#
name: Publish to Apple App Store
on:
  workflow_call:
    inputs:
      # === IPA SOURCE ===
      ipa-artifact-name:
        description: "Name of artifact containing IPA file"
        required: true
        type: string
      ipa-path:
        description: "Path to IPA file within artifact (supports glob)"
        required: false
        default: "**/*.ipa"
        type: string
      # === APP STORE CONFIGURATION ===
      app-id:
        description: "App Store Connect App ID (bundle identifier)"
        required: false
        type: string
      platform:
        description: "Platform (ios, macos, tvos)"
        required: false
        default: "ios"
        type: string
      # === SUBMISSION OPTIONS ===
      submit-for-review:
        description: "Submit for App Store review (not just TestFlight)"
        required: false
        default: false
        type: boolean
      skip-validation:
        description: "Skip IPA validation before upload"
        required: false
        default: false
        type: boolean
      # === SYSTEM ===
      working-directory:
        description: "Working directory"
        required: false
        default: "."
        type: string
      macos-version:
        description: "macOS runner version (macos-13, macos-14, macos-15)"
        required: false
        default: "macos-14"
        type: string
permissions:
  contents: read
jobs:
  publish:
    name: Publish to App Store Connect
    runs-on: ${{ inputs.macos-version }}
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0

      - name: Download IPA artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: ${{ inputs['ipa-artifact-name'] }}
          path: artifacts/

      - name: Find IPA file
        id: find-ipa
        run: |
          IPA_FILE=$(find artifacts -name "*.ipa" -type f | head -1)

          if [ -z "$IPA_FILE" ]; then
            printf "::error::No IPA file found in artifact\n"
            exit 1
          fi

          printf "ipa-file=%s\n" "${IPA_FILE}" >> "$GITHUB_OUTPUT"
          printf "Found IPA: %s\n" "${IPA_FILE}"

          ls -lh "$IPA_FILE"

      - name: Setup App Store Connect API
        env:
          APP_STORE_CONNECT_API_PRIVATE_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_PRIVATE_KEY_BASE64 }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        run: |
          if [ -z "$APP_STORE_CONNECT_API_PRIVATE_KEY_BASE64" ]; then
            printf "::error::APP_STORE_CONNECT_API_PRIVATE_KEY_BASE64 secret not found\n"
            exit 1
          fi
          if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ]; then
            printf "::error::APP_STORE_CONNECT_API_KEY_ID secret not found\n"
            exit 1
          fi

          mkdir -p private_keys
          printf "%s" "$APP_STORE_CONNECT_API_PRIVATE_KEY_BASE64" | base64 --decode -o "private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"

          printf "âœ“ App Store Connect API configured\n"

      - name: Validate IPA
        if: ${{ !inputs['skip-validation'] }}
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          printf "Validating IPA...\n"

          xcrun altool \
            --validate-app \
            --file "${{ steps.find-ipa.outputs.ipa-file }}" \
            --type ${{ inputs.platform }} \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --output-format json

          printf "âœ“ IPA validation passed\n"

      - name: Upload to App Store Connect
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          set -o pipefail

          printf "Uploading IPA to App Store Connect...\n"

          xcrun altool \
            --output-format json \
            --upload-app \
            --file "${{ steps.find-ipa.outputs.ipa-file }}" \
            --type ${{ inputs.platform }} \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
          | tee upload-result.json

          printf "âœ“ Upload successful\n"

      - name: Parse upload results
        id: upload-info
        run: |
          if [ -f upload-result.json ]; then
            REQUEST_ID=$(jq -r '.["product-errors"][]?.requestId // .["success-message"] // "unknown"' upload-result.json)
            printf "request-id=%s\n" "${REQUEST_ID}" >> "$GITHUB_OUTPUT"
            printf "Upload Request ID: %s\n" "${REQUEST_ID}"
          fi

      - name: Generate upload summary
        run: |
          printf "## App Store Connect Upload Summary ðŸ“±\n" >> $GITHUB_STEP_SUMMARY
          printf "\n" >> $GITHUB_STEP_SUMMARY
          printf "### Upload Details\n" >> $GITHUB_STEP_SUMMARY
          printf "| Property | Value |\n" >> $GITHUB_STEP_SUMMARY
          printf "|----------|-------|\n" >> $GITHUB_STEP_SUMMARY
          printf "| **IPA File** | \`%s\` |\n" "$(basename ${{ steps.find-ipa.outputs.ipa-file }})" >> $GITHUB_STEP_SUMMARY
          printf "| **Platform** | %s |\n" "${{ inputs.platform }}" >> $GITHUB_STEP_SUMMARY
          printf "| **Validation** | %s |\n" "${{ inputs['skip-validation'] && 'âŠ˜ Skipped' || 'âœ“ Passed' }}" >> $GITHUB_STEP_SUMMARY
          printf "| **Status** | âœ“ Uploaded |\n" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.upload-info.outputs.request-id }}" ]; then
            printf "| **Request ID** | \`%s\` |\n" "${{ steps.upload-info.outputs.request-id }}" >> $GITHUB_STEP_SUMMARY
          fi

          printf "\n" >> $GITHUB_STEP_SUMMARY
          printf "### Next Steps\n" >> $GITHUB_STEP_SUMMARY
          printf "1. Check [App Store Connect](https://appstoreconnect.apple.com) for build processing status\n" >> $GITHUB_STEP_SUMMARY
          printf "2. Build will be available in TestFlight within 10-15 minutes after processing completes\n" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs['submit-for-review'] }}" = "true" ]; then
            printf "3. Build will be automatically submitted for App Store review\n" >> $GITHUB_STEP_SUMMARY
          else
            printf "3. Manually submit for external testing or App Store review from App Store Connect\n" >> $GITHUB_STEP_SUMMARY
          fi

          printf "\n" >> $GITHUB_STEP_SUMMARY
          printf "*Upload completed at %s*\n" "$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Upload result artifact
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: appstore-upload-result
          path: upload-result.json
          retention-days: 30
