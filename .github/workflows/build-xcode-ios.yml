# SPDX-FileCopyrightText: 2025 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0
# Xcode iOS Builder
# 
# Purpose: Builds iOS/macOS applications with Xcode, creating IPA files for
# distribution to TestFlight or App Store.
#
# Build Process:
#   1. Set up Xcode environment and select version
#   2. Configure code signing (certificates and provisioning profiles)
#   3. Archive application using xcodebuild
#   4. Export IPA with specified export method
#   5. Upload IPA artifacts with custom naming
#
# Features:
#   - Multiple Xcode versions support
#   - Configurable schemes and configurations
#   - iOS code signing with certificates and provisioning profiles
#   - IPA export with custom options
#   - Date-stamped artifact names
#   - Custom artifact naming (environment prefixes)
#   - Support for workspace or project files
#
# Outputs:
#   - IPA artifacts with custom names
#   - Examples: "2025-01-15 - demo_store - wallet-app-ios - Wallet Demo - IPA Release"
#
# Required Secrets (for signing):
#   CERTIFICATE_BASE64: Base64-encoded distribution certificate (.p12)
#   CERTIFICATE_PASSPHRASE: Certificate passphrase
#   PROVISIONING_PROFILE_BASE64: Base64-encoded provisioning profile
#   KEYCHAIN_PASSWORD: Temporary keychain password
#   EXPORT_OPTIONS_BASE64: Base64-encoded exportOptions.plist (optional, can use vars)
#
# Required Permissions:
#   contents: read  # Checkout code
#
name: Build Xcode iOS
on:
  workflow_call:
    inputs:
      # === REQUIRED ===
      xcode-version:
        description: "Xcode version (e.g., 16.1, 15.4)"
        required: true
        type: string
      scheme:
        description: "Xcode scheme to build (e.g., 'Wallet Demo', 'MyApp')"
        required: true
        type: string
      # === XCODE PROJECT CONFIGURATION ===
      workspace:
        description: "Xcode workspace file (e.g., App.xcworkspace). Mutually exclusive with project."
        required: false
        type: string
      project:
        description: "Xcode project file (e.g., App.xcodeproj). Mutually exclusive with workspace."
        required: false
        type: string
      configuration:
        description: "Build configuration (Debug, Release)"
        required: false
        default: "Release"
        type: string
      # === CODE SIGNING ===
      enable-code-signing:
        description: "Enable iOS code signing with certificates and provisioning profiles"
        required: false
        default: true
        type: boolean
      # === EXPORT OPTIONS ===
      export-options-var:
        description: "Name of GitHub variable containing base64-encoded exportOptions.plist"
        required: false
        default: "EXPORT_OPTIONS_BASE64"
        type: string
      # === ARTIFACT NAMING ===
      artifact-name:
        description: "Exact artifact name (overrides auto-generated name if set)"
        required: false
        default: ""
        type: string
      include-tag:
        description: "Include git tag/ref in artifact name"
        required: false
        default: true
        type: boolean
      # === BUILD CONFIGURATION ===
      working-directory:
        description: "Working directory"
        required: false
        default: "."
        type: string
      destination:
        description: "Build destination (default: generic/platform=iOS)"
        required: false
        default: "generic/platform=iOS"
        type: string
      # === MACOS RUNNER ===
      macos-version:
        description: "macOS runner version (macos-13, macos-14, macos-15, macos-26)"
        required: false
        default: "macos-26"
        type: string
      reusable-ci-ref:
        description: "Ref for reusable-ci scripts checkout (for testing feature branches)"
        required: false
        default: "main"
        type: string
permissions:
  contents: read
jobs:
  build-variants:
    name: Build Xcode iOS
    runs-on: ${{ inputs.macos-version }}
    timeout-minutes: 60
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - name: Checkout .github repository for scripts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: diggsweden/reusable-ci
          ref: ${{ inputs.reusable-ci-ref }}
          path: .github-shared
          sparse-checkout: scripts

      - name: Generate artifact names
        id: artifact-names
        run: |
          if [ -n "${{ inputs['artifact-name'] }}" ]; then
            BASE_NAME="${{ inputs['artifact-name'] }}"
          else
            BASE_NAME="${{ github.event.repository.name }}"
          fi

          if [ "${{ inputs['include-tag'] }}" = "true" ]; then
            IPA_NAME="${BASE_NAME}-${{ github.ref_name }}"
          else
            IPA_NAME="${BASE_NAME}"
          fi

          printf "ipa-name=%s\n" "${IPA_NAME}" >> "$GITHUB_OUTPUT"
          printf "IPA artifact: %s\n" "${IPA_NAME}"

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ inputs.xcode-version }}.app
          xcodebuild -version

      - name: Install build dependencies
        run: |
          if ! command -v xcbeautify &> /dev/null; then
            brew install xcbeautify
          fi
          printf "âœ“ xcbeautify installed\n"

      - name: Setup code signing
        if: ${{ inputs['enable-code-signing'] }}
        env:
          CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSPHRASE: ${{ secrets.CERTIFICATE_PASSPHRASE }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: bash .github-shared/scripts/xcode/setup-code-signing.sh

      - name: Get version info
        id: version-info
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          bash .github-shared/scripts/xcode/get-version-info.sh \
            "${{ inputs.project }}" \
            "${{ inputs.workspace }}" >> "$GITHUB_OUTPUT"

      - name: Archive app
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          set -o pipefail
          mkdir -p build

          BUILD_CMD="xcodebuild archive"

          if [ -n "${{ inputs.workspace }}" ]; then
            BUILD_CMD="$BUILD_CMD -workspace ${{ inputs.workspace }}"
          elif [ -n "${{ inputs.project }}" ]; then
            BUILD_CMD="$BUILD_CMD -project ${{ inputs.project }}"
          fi

          BUILD_CMD="$BUILD_CMD -scheme '${{ inputs.scheme }}'"
          BUILD_CMD="$BUILD_CMD -configuration ${{ inputs.configuration }}"
          BUILD_CMD="$BUILD_CMD -archivePath build/app.xcarchive"
          BUILD_CMD="$BUILD_CMD -destination '${{ inputs.destination }}'"
          BUILD_CMD="$BUILD_CMD -skipPackagePluginValidation"

          printf "Running: %s\n" "$BUILD_CMD"
          eval "$BUILD_CMD" | xcbeautify

      - name: Export IPA
        if: ${{ inputs['enable-code-signing'] }}
        working-directory: ${{ inputs['working-directory'] }}
        env:
          EXPORT_OPTIONS_BASE64: ${{ vars[inputs.export-options-var] }}
        run: |
          set -o pipefail

          if [ -z "$EXPORT_OPTIONS_BASE64" ]; then
            printf "::error::Export options not found in variable %s\n" "${{ inputs.export-options-var }}"
            exit 1
          fi

          printf "%s" "$EXPORT_OPTIONS_BASE64" | base64 --decode > export-options.plist

          xcodebuild -exportArchive \
            -archivePath build/app.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist export-options.plist \
          | xcbeautify

      - name: List built artifacts
        working-directory: ${{ inputs['working-directory'] }}
        run: |
          printf "Built artifacts:\n"
          find build -type f \( -name "*.ipa" -o -name "*.xcarchive" \) -ls || printf "No artifacts found\n"

      - name: Upload IPA artifact
        if: ${{ inputs['enable-code-signing'] }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ steps.artifact-names.outputs.ipa-name }}
          path: |
            ${{ inputs['working-directory'] }}/build/export/*.ipa
          retention-days: 7

      - name: Upload archive (unsigned builds)
        if: ${{ !inputs['enable-code-signing'] }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ steps.artifact-names.outputs.ipa-name }}-archive
          path: |
            ${{ inputs['working-directory'] }}/build/app.xcarchive
          retention-days: 7

      - name: Generate build summary
        run: |
          bash .github-shared/scripts/summary/xcode-build-summary.sh \
            "${{ inputs.xcode-version }}" \
            "${{ inputs.scheme }}" \
            "${{ inputs.configuration }}" \
            "${{ inputs.destination }}" \
            "${{ inputs['enable-code-signing'] }}" \
            "${{ steps.version-info.outputs.version }}" \
            "${{ steps.version-info.outputs.build }}" \
            "${{ steps.artifact-names.outputs.ipa-name }}" >> "$GITHUB_STEP_SUMMARY"
