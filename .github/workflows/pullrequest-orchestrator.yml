# SPDX-FileCopyrightText: 2025 Digg - Agency for Digital Government
#
# SPDX-License-Identifier: CC0-1.0
# Pull Request Orchestrator
# 
# Purpose: Orchestrates all quality checks for pull requests and pushes, ensuring
# code quality, security, and compliance before merging. Provides a configurable
# set of linters and security scanners that can be toggled per project needs.
#
# How it works:
# 1. Runs on every push to configured branches and on pull requests
# 2. Executes enabled linters in parallel for faster feedback
# 3. Performs security scanning (SAST, dependency checks, secret detection)
# 4. Validates licenses for compliance
# 5. Uploads results to GitHub Security tab for visibility
#
# Security controls:
# - Secret detection to prevent credential leaks
# - Dependency vulnerability scanning
# - License compliance validation
# - SAST (Static Application Security Testing)
# - Results uploaded to GitHub Security dashboard
#
# Required Secrets:
#   None required - uses GITHUB_TOKEN for operations
#   Optional: Organization secrets for private package access
#
# Required Permissions:
#   contents: read         # Read source code
#   packages: read         # Access private packages
#   security-events: write # Upload security findings
#
# Configurable Linters:
#   linters.commitlint: Commit message linting (default: true)
#   linters.licenselint: License compliance checking (default: true)
#   linters.dependencyreview: Dependency vulnerability scan (default: true)
#   linters.megalint: MegaLinter with 50+ linters (default: true)
#   linters.publiccodelint: Publiccode.yml validation (default: false)
#   linters.justmiselint: Just+mise-based linting (default: false)
name: Pull Request Orchestrator
on:
  workflow_call:
    inputs:
      # Project configuration
      project-type:
        description: "Project type: maven, npm, python"
        required: true
        type: string
      base-branch:
        description: "Base branch for commit linting (auto-detects PR target if empty)"
        required: false
        default: ""
        type: string
      # Linter toggles (all can be disabled if needed)
      linters.commitlint:
        description: "⚠️ DEPRECATED v3.0: Enable commit message linting (migrate to justmiselint)"
        required: false
        default: true
        type: boolean
      linters.licenselint:
        description: "⚠️ DEPRECATED v3.0: Enable SPDX license header linting (migrate to justmiselint)"
        required: false
        default: true
        type: boolean
      linters.dependencyreview:
        description: "Enable dependency vulnerability review"
        required: false
        default: true
        type: boolean
      linters.megalint:
        description: "⚠️ DEPRECATED v3.0: Enable MegaLinter (migrate to justmiselint)"
        required: false
        default: true
        type: boolean
      linters.publiccodelint:
        description: "⚠️ DEPRECATED v3.0: Enable publiccode.yml linting (migrate to justmiselint)"
        required: false
        default: false
        type: boolean
      linters.justmiselint:
        description: "✅ RECOMMENDED: Enable just+mise-based linting (replaces megalint, commitlint, licenselint, publiccodelint)"
        required: false
        default: false
        type: boolean
      linters.swiftformat:
        description: "Enable swift-format (Google Swift Style Guide) for iOS/macOS projects"
        required: false
        default: false
        type: boolean
      linters.swiftlint:
        description: "Enable SwiftLint (comprehensive linting rules) for iOS/macOS projects"
        required: false
        default: false
        type: boolean
      reusable-ci-ref:
        description: "Ref for reusable-ci scripts checkout (for testing feature branches)"
        required: false
        default: "main"
        type: string
permissions:
  contents: read # Best Security practice. Jobs only get read as base, and then permissions are added as needed
jobs:
  # Commit message linting
  commit-lint:
    name: Commit Lint
    if: ${{ inputs['linters.commitlint'] }}
    uses: ./.github/workflows/lint-commit.yml
    with:
      base-branch: ${{ inputs['base-branch'] }}
  # License header linting
  license-lint:
    name: License Lint
    if: ${{ inputs['linters.licenselint'] }}
    uses: ./.github/workflows/lint-license.yml
  # Dependency security review
  dependency-review:
    name: Dependency Review
    if: ${{ inputs['linters.dependencyreview'] }}
    uses: ./.github/workflows/security-dependency-review.yml
  #  linting with MegaLinter
  megalint:
    name: MegaLinter
    if: ${{ inputs['linters.megalint'] }}
    permissions:
      contents: read
      security-events: write
    uses: ./.github/workflows/lint-mega.yml
  # Public code metadata linting
  publiccode-lint:
    name: Publiccode Lint
    if: ${{ inputs['linters.publiccodelint'] }}
    uses: ./.github/workflows/lint-publiccode.yml
  # Just+mise-based linting
  just-mise-lint:
    name: Just+Mise Lint
    if: ${{ inputs['linters.justmiselint'] }}
    permissions:
      contents: read
      security-events: write
    uses: ./.github/workflows/lint-just-mise.yml
    with:
      reusable-ci-ref: ${{ inputs.reusable-ci-ref }}
  # Swift linting
  swift-lint:
    name: Swift Lint
    if: ${{ inputs['linters.swiftformat'] || inputs['linters.swiftlint'] }}
    permissions:
      contents: read
    uses: ./.github/workflows/lint-swift.yml
    with:
      enable-swiftformat: ${{ inputs['linters.swiftformat'] }}
      enable-swiftlint: ${{ inputs['linters.swiftlint'] }}
  # Gather results from enabled linters (always runs to check status)
  lint-status:
    name: Lint Status Check
    runs-on: ubuntu-latest
    if: always()
    needs: [commit-lint, license-lint, dependency-review, megalint, publiccode-lint, just-mise-lint, swift-lint]
    steps:
      - name: Checkout reusable-ci scripts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: diggsweden/reusable-ci
          ref: ${{ inputs.reusable-ci-ref }}
          path: .github-shared
          sparse-checkout: scripts
      - name: Check lint results
        run: |
          bash .github-shared/scripts/lint/generate-status-report.sh \
            "Commit Lint|${{ inputs['linters.commitlint'] }}|${{ needs.commit-lint.result }}|true" \
            "License Lint|${{ inputs['linters.licenselint'] }}|${{ needs.license-lint.result }}|true" \
            "Dependency Review|${{ inputs['linters.dependencyreview'] }}|${{ needs.dependency-review.result }}|false" \
            "MegaLinter|${{ inputs['linters.megalint'] }}|${{ needs.megalint.result }}|true" \
            "Publiccode Lint|${{ inputs['linters.publiccodelint'] }}|${{ needs.publiccode-lint.result }}|true" \
            "Just+Mise Lint|${{ inputs['linters.justmiselint'] }}|${{ needs.just-mise-lint.result }}|false" \
            "Swift Lint|${{ inputs['linters.swiftformat'] == 'true' || inputs['linters.swiftlint'] == 'true' }}|${{ needs.swift-lint.result }}|false"
