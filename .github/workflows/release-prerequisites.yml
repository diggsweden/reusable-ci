# SPDX-FileCopyrightText: 2025 The Reusable CI Authors
#
# SPDX-License-Identifier: CC0-1.0
# Release Prerequisites Validator
# 
# Purpose: Validates that all requirements for a successful release are met before
# attempting the actual release process. Prevents failed releases by checking
# credentials, permissions, and configuration early in the process.
#
# How it works:
# 1. Validates tag follows semantic versioning (vX.Y.Z)
# 2. Verifies tag is cryptographically signed (GPG or SSH)
# 3. Checks tag version matches project version (pom.xml/package.json)
# 4. Validates all required secrets are present and valid
# 5. Tests authentication to target registries (Maven Central, NPM, ghcr.io)
# 6. Verifies GPG keys are valid and not expired
# 7. Checks user authorization for non-SNAPSHOT releases (if configured)
# 8. Generates detailed validation report
#
# Security controls:
# - Requires cryptographically signed tags (GPG or SSH) for all releases
# - Never logs secret values, only validation status
# - Checks GPG key expiration dates
# - Validates user is in authorized developers list (if enabled)
# - Verifies registry credentials before attempting publish
#
# Required Secrets (depending on configuration):
#   GPG_SECRET_KEY: For signature validation
#   GPG_PASSPHRASE: For signature validation
#   MAVENCENTRAL_USERNAME: For Maven Central auth check
#   MAVENCENTRAL_PASSWORD: For Maven Central auth check
#   NPM_TOKEN: For NPM registry auth check
#   AUTHORIZED_DEVELOPERS: Comma-separated list of authorized users
#
# Required Permissions:
#   contents: read   # Read version files
#   packages: read   # Verify package registry access
#
# Usage:
# Called automatically as the first step in release-orchestrator.yml
# Can also be run manually via workflow_dispatch for testing
name: Validate Release Prerequisites
on:
  workflow_call: # yamllint disable-line rule:truthy
    inputs:
      project-type:
        description: "Project type: maven, npm"
        required: true
        type: string
      build-type:
        description: "Build type: application or library"
        required: false
        default: "application"
        type: string
      container-registry:
        description: "Container registry"
        required: false
        default: "ghcr.io"
        type: string
      sign-artifacts:
        description: "Whether artifacts will be GPG signed"
        required: false
        default: true
        type: boolean
      check-authorization:
        description: "Check if user is authorized for non-SNAPSHOT releases"
        required: false
        default: false
        type: boolean
      branch:
        description: "Target branch for release (default: main)"
        required: false
        default: "main"
        type: string
  workflow_dispatch: # Allow manual validation
    inputs:
      project-type:
        description: "Project type"
        required: true
        type: choice
        options:
          - maven
          - npm
permissions:
  contents: read # Best Security practice. Jobs only get read as base, and then permissions are added as needed
jobs:
  validate:
    name: Validate Prerequisites
    runs-on: ubuntu-latest
    # ============================================================================
    # This job validates all prerequisites required for a successful release:
    #   1. Tag Validation - Format, signature, uniqueness, commit availability
    #   2. Authorization - User permissions for non-SNAPSHOT releases
    #   3. Secrets & Credentials - GPG keys, tokens, publishing credentials
    #   4. Summary Generation -  validation report
    # ============================================================================
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Checkout .github repository for scripts
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          repository: diggsweden/reusable-ci
          ref: ${{ github.workflow_sha }}
          path: .github-shared
          sparse-checkout: scripts
      - name: Debug - List checked out files
        run: |
          printf "=== Workspace structure ===\n"
          ls -la
          printf "\n"
          printf "=== .github-shared structure ===\n"
          ls -la .github-shared/ || printf ".github-shared not found\n"
          printf "\n"
          printf "=== Looking for scripts ===\n"
          find .github-shared -name "validate-*.sh" 2>/dev/null || printf "No scripts found\n"
          printf "\n"
          printf "=== GitHub context ===\n"
          printf "action_repository: %s\n" "${{ github.action_repository }}"
          printf "action_ref: %s\n" "${{ github.action_ref }}"
      - name: Verify Triggered by Tag
        run: |
          if [ "${{ github.ref_type }}" != "tag" ]; then
            printf "::error::❌ Release workflow must be triggered by pushing a tag\n"
            printf "::error::Current trigger: %s (%s)\n" "${{ github.ref_type }}" "${{ github.ref }}"
            printf "::error::To create a release, push a signed tag:\n"
            printf "::error::  git tag -s v1.0.0 -m 'Release v1.0.0'\n"
            printf "::error::  git push origin v1.0.0\n"
            exit 1
          fi
          printf "✓ Triggered by tag: %s\n" "${{ github.ref_name }}"
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.OSPO_BOT_GPG_PRIV }}
          passphrase: ${{ secrets.OSPO_BOT_GPG_PASS }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: true
      - name: Fetch all tags
        run: |
          printf "Fetching all tags to ensure we have tag objects...\n"
          git fetch --tags --force
      - name: Validate Tag Format
        if: ${{ github.ref_type == 'tag' }}
        run: bash .github-shared/scripts/validation/validate-tag-format.sh "${{ github.ref_name }}"
      - name: Validate Tag Signature
        if: ${{ github.ref_type == 'tag' }}
        env:
          OSPO_BOT_GPG_PUB: ${{ secrets.OSPO_BOT_GPG_PUB }}
        run: bash .github-shared/scripts/validation/validate-tag-signature.sh "${{ github.ref_name }}" "${{ github.repository }}" "$OSPO_BOT_GPG_PUB"
      - name: Validate Tag Uniqueness
        if: ${{ github.ref_type == 'tag' }}
        run: |
          printf "→ Validating Tag Points to Unique Commit\n"
          TAG_NAME="${{ github.ref_name }}"

          # Get the commit SHA this tag points to
          TAG_COMMIT=$(git rev-parse "$TAG_NAME^{commit}")
          printf "✓ Tag '%s' points to commit: %s\n" "$TAG_NAME" "$TAG_COMMIT"

          # Find all other tags pointing to the same commit
          OTHER_TAGS=$(git tag --points-at "$TAG_COMMIT" | grep -v "^${TAG_NAME}$" || true)

          if [ -n "$OTHER_TAGS" ]; then
            printf "::error::Tag '%s' points to the same commit as other tag(s)\n" "$TAG_NAME"
            printf "\n"
            printf "The following tags also point to commit %s:\n" "$TAG_COMMIT"
            printf "%s\n" "$OTHER_TAGS" | sed 's/^/  - /'
            printf "\n"
            printf "Multiple tags on the same commit cause changelog generation issues.\n"
            printf "This is a known limitation in git-cliff:\n"
            printf "https://github.com/orhun/git-cliff/issues/1036\n"
            printf "\n"
            exit 1
          fi

          printf "✓ Tag '%s' points to a unique commit\n" "$TAG_NAME"
          printf "✓ No other tags found on commit %s\n" "$TAG_COMMIT"
      - name: Validate Tag Commit Availability
        if: ${{ github.ref_type == 'tag' }}
        run: bash .github-shared/scripts/validation/validate-tag-commit.sh "${{ github.ref_name }}" "${{ inputs.branch }}"
      # ============================================================================
      # SECTION 2: Authorization Validation
      # Checks if user is authorized for non-SNAPSHOT releases
      # ============================================================================
      - name: Check Release Authorization
        if: ${{ inputs['check-authorization'] }}
        run: |
          # Check if this is a SNAPSHOT release
          TAG_NAME="${{ github.ref_name }}"
          if [[ "${TAG_NAME}" == *-SNAPSHOT ]]; then
            printf "− SNAPSHOT release - authorization check skipped\n"
            exit 0
          fi

          # For non-SNAPSHOT releases, check if actor is authorized
          AUTHORIZED_DEVS="${{ secrets.AUTHORIZED_RELEASE_DEVELOPERS }}"
          ACTOR="${{ github.actor }}"

          if [ -z "$AUTHORIZED_DEVS" ]; then
            printf "::warning::AUTHORIZED_RELEASE_DEVELOPERS secret not configured\n"
            printf "All users with tag push access can create releases\n"
            printf "✓ Authorization check passed (no restrictions configured)\n"
            exit 0
          fi

          # Check if current actor is in the authorized list
          if printf ",%s," "$AUTHORIZED_DEVS" | grep -q ",$ACTOR,"; then
            printf "✓ User '%s' is authorized to create production releases\n" "$ACTOR"
          else
            printf "::error::User '%s' is not authorized to create non-SNAPSHOT releases\n" "$ACTOR"
            printf "Only the following users can create production releases:\n"
            printf "%s\n" "$AUTHORIZED_DEVS" | tr ',' '\n' | sed 's/^/  - /'
            printf "\n"
            printf "If you need to create a release, please:\n"
            printf "1. Contact one of the authorized developers\n"
            printf "2. Or create a SNAPSHOT release instead (tag with -SNAPSHOT suffix)\n"
            exit 1
          fi
      # ============================================================================
      # SECTION 3: Secrets and Credentials Validation
      # Validates GPG keys, GitHub tokens, and publishing credentials
      # ============================================================================
      - name: Validate GPG Configuration
        if: ${{ inputs['sign-artifacts'] }}
        id: gpg-test
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.OSPO_BOT_GPG_PRIV }}
          passphrase: ${{ secrets.OSPO_BOT_GPG_PASS }}
          git_user_signingkey: true
      - name: Validate GPG Public Key
        if: ${{ inputs['sign-artifacts'] }}
        run: |
          if [ -z "${{ secrets.OSPO_BOT_GPG_PUB }}" ]; then
            printf "::error::Missing OSPO_BOT_GPG_PUB secret\n"
            printf "This secret is needed for GPG operations and signing\n"
            printf "Add it in Settings → Secrets → Actions\n"
            exit 1
          fi
          printf "✓ GPG public key configured\n"
      - name: Validate GitHub Push Token
        run: |
          # OSPO_BOT_GHTOKEN is required for pushing version bumps
          if [ -z "${{ secrets.OSPO_BOT_GHTOKEN }}" ]; then
            printf "::error::Missing OSPO_BOT_GHTOKEN secret\n"
            printf "This token is required for:\n"
            printf "  - Pushing version bump commits\n"
            printf "  - Moving tags after version bump\n"
            printf "  - Pushing changelog updates\n"
            printf "\n"
            printf "Create a PAT with 'repo' scope and add as OSPO_BOT_GHTOKEN secret\n"
            exit 1
          fi

          # Test token validity and permissions
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.OSPO_BOT_GHTOKEN }}" \
            https://api.github.com/repos/${{ github.repository }})

          if [ "$RESPONSE" != "200" ]; then
            printf "::error::OSPO_BOT_GHTOKEN is invalid or lacks permissions\n"
            printf "HTTP Response: %s\n" "$RESPONSE"
            printf "Ensure the token has 'repo' scope\n"
            exit 1
          fi

          printf "✓ GitHub push token validated\n"
      - name: Validate Release Token
        run: |
          # RELEASE_TOKEN is required for creating GitHub releases
          TOKEN="${{ secrets.RELEASE_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            printf "::error::Missing RELEASE_TOKEN secret\n"
            printf "This token is required for creating GitHub releases\n"
            printf "GITHUB_TOKEN cannot be used as it lacks permissions when workflows chain\n"
            printf "Add it in Settings → Secrets → Actions\n"
            exit 1
          else
            # Test RELEASE_TOKEN
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/releases)

            if [ "$RESPONSE" != "200" ]; then
              printf "::error::RELEASE_TOKEN is invalid or lacks permissions\n"
              exit 1
            fi
            printf "Release token validated\n"
          fi
      - name: Validate Bot Token Permissions
        env:
          GH_TOKEN: ${{ secrets.OSPO_BOT_GHTOKEN }}
        run: |
          printf "Validating bot token permissions...\n"

          # Check if the bot token is available
          if [ -z "${{ secrets.OSPO_BOT_GHTOKEN }}" ]; then
            printf "::error::Cannot validate bot permissions without OSPO_BOT_GHTOKEN\n"
            exit 1
          fi

          # Test if token can authenticate (without revealing details)
          if ! gh api user --silent 2>/dev/null; then
            printf "::error::OSPO_BOT_GHTOKEN is invalid or expired\n"
            exit 1
          fi

          # Test if token has basic repository access (without revealing who/what permissions)
          if ! gh api repos/${{ github.repository }} --silent 2>/dev/null; then
            printf "::error::Bot token cannot access this repository\n"
            printf "Please ensure the bot has appropriate repository access\n"
            exit 1
          fi

          # Try to check for write permissions by querying branches (less revealing)
          if ! gh api repos/${{ github.repository }}/branches --silent 2>/dev/null; then
            printf "::warning::Bot token may have limited permissions\n"
            printf "Ensure the bot has sufficient permissions to:\n"
            printf "  - Push commits to branches\n"
            printf "  - Create and move tags\n"
            printf "  - Bypass branch protection (if enabled)\n"
          fi

          printf "✓ Bot token is valid and has repository access\n"
      - name: Validate Maven Central Credentials
        if: ${{ inputs['build-type'] == 'library' }}
        run: |
          if [ -z "${{ secrets.MAVENCENTRAL_USERNAME }}" ]; then
            printf "::error::Missing MAVENCENTRAL_USERNAME secret\n"
            printf "Required for publishing to Maven Central\n"
            exit 1
          fi

          if [ -z "${{ secrets.MAVENCENTRAL_PASSWORD }}" ]; then
            printf "::error::Missing MAVENCENTRAL_PASSWORD secret\n"
            printf "Required for publishing to Maven Central\n"
            exit 1
          fi

          printf "✓ Maven Central credentials configured\n"
      # NOTE: NPM publishing to npmjs.org not yet implemented in v2
      # NPM packages are attached to GitHub Release as tarballs
      # This validation will be re-enabled when NPM publishing is added
      # ============================================================================
      # SECTION 4: Summary Generation
      # Creates  validation report
      # ============================================================================
      - name: Generate Validation Summary
        if: always()
        env:
          TAG_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          REF_TYPE: ${{ github.ref_type }}
          PROJECT_TYPE: ${{ inputs['project-type'] }}
          BUILD_TYPE: ${{ inputs['build-type'] }}
          CONTAINER_REGISTRY: ${{ inputs['container-registry'] }}
          SIGN_ARTIFACTS: ${{ inputs['sign-artifacts'] }}
          CHECK_AUTHORIZATION: ${{ inputs['check-authorization'] }}
          ACTOR: ${{ github.actor }}
          JOB_STATUS: ${{ job.status }}
          OSPO_BOT_GPG_PRIV: ${{ secrets.OSPO_BOT_GPG_PRIV }}
          OSPO_BOT_GHTOKEN: ${{ secrets.OSPO_BOT_GHTOKEN }}
          OSPO_BOT_GPG_PUB: ${{ secrets.OSPO_BOT_GPG_PUB }}
          RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          MAVENCENTRAL_USERNAME: ${{ secrets.MAVENCENTRAL_USERNAME }}
          MAVENCENTRAL_PASSWORD: ${{ secrets.MAVENCENTRAL_PASSWORD }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          bash .github-shared/scripts/validation/generate-prerequisites-summary.sh
