# SPDX-FileCopyrightText: 2025 The Reusable CI Authors
#
# SPDX-License-Identifier: CC0-1.0

# Release Prerequisites Validator
# 
# Purpose: Validates that all requirements for a successful release are met before
# attempting the actual release process. Prevents failed releases by checking
# credentials, permissions, and configuration early in the process.
#
# How it works:
# 1. Validates tag follows semantic versioning (vX.Y.Z)
# 2. Verifies tag is cryptographically signed (GPG or SSH)
# 3. Checks tag version matches project version (pom.xml/package.json)
# 4. Validates all required secrets are present and valid
# 5. Tests authentication to target registries (Maven Central, NPM, ghcr.io)
# 6. Verifies GPG keys are valid and not expired
# 7. Checks user authorization for non-SNAPSHOT releases (if configured)
# 8. Generates detailed validation report
#
# Security controls:
# - Requires cryptographically signed tags (GPG or SSH) for all releases
# - Never logs secret values, only validation status
# - Checks GPG key expiration dates
# - Validates user is in authorized developers list (if enabled)
# - Verifies registry credentials before attempting publish
#
# Required Secrets (depending on configuration):
#   GPG_SECRET_KEY: For signature validation
#   GPG_PASSPHRASE: For signature validation
#   MAVENCENTRAL_USERNAME: For Maven Central auth check
#   MAVENCENTRAL_PASSWORD: For Maven Central auth check
#   NPM_TOKEN: For NPM registry auth check
#   AUTHORIZED_DEVELOPERS: Comma-separated list of authorized users
#
# Required Permissions:
#   contents: read   # Read version files
#   packages: read   # Verify package registry access
#
# Usage:
# Called automatically as the first step in release-orchestrator.yml
# Can also be run manually via workflow_dispatch for testing
name: Validate Release Prerequisites
on:
  workflow_call: # yamllint disable-line rule:truthy
    inputs:
      projectType:
        description: "Project type: maven, npm"
        required: true
        type: string
      useJReleaser:
        description: "Whether JReleaser will be used"
        required: false
        default: false
        type: boolean
      artifactPublisher:
        description: "Artifact publisher being used"
        required: false
        type: string
      containerRegistry:
        description: "Container registry"
        required: false
        default: "ghcr.io"
        type: string
      signArtifacts:
        description: "Whether artifacts will be GPG signed"
        required: false
        default: true
        type: boolean
      checkAuthorization:
        description: "Check if user is authorized for non-SNAPSHOT releases"
        required: false
        default: false
        type: boolean
      branch:
        description: "Target branch for release (default: main)"
        required: false
        default: "v1"
        type: string
      workflowsRef:
        description: ".github repository ref for validation scripts (default: main)"
        required: false
        default: "v1"
        type: string
  workflow_dispatch: # Allow manual validation
    inputs:
      projectType:
        description: "Project type"
        required: true
        type: choice
        options:
          - maven
          - npm
      useJReleaser:
        description: "Using JReleaser?"
        required: false
        type: boolean
        default: false
permissions:
  contents: read # Best Security practice. Jobs only get read as base, and then permissions are added as needed
jobs:
  validate:
    name: Validate Prerequisites
    runs-on: ubuntu-latest
    # ============================================================================
    # This job validates all prerequisites required for a successful release:
    #   1. Tag Validation - Format, signature, uniqueness, commit availability
    #   2. Authorization - User permissions for non-SNAPSHOT releases
    #   3. Secrets & Credentials - GPG keys, tokens, publishing credentials
    #   4. Summary Generation - Comprehensive validation report
    # ============================================================================
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Checkout .github repository for scripts
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: diggsweden/reusable-ci
          ref: ${{ inputs.workflowsRef }}
          path: .github-shared
          sparse-checkout: |
            scripts/validation
      - name: Debug - List checked out files
        run: |
          echo "=== Workspace structure ==="
          ls -la
          echo ""
          echo "=== .github-shared structure ==="
          ls -la .github-shared/ || echo ".github-shared not found"
          echo ""
          echo "=== Looking for scripts ==="
          find .github-shared -name "validate-*.sh" 2>/dev/null || echo "No scripts found"
          echo ""
          echo "=== GitHub context ==="
          echo "action_repository: ${{ github.action_repository }}"
          echo "action_ref: ${{ github.action_ref }}"
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.OSPO_BOT_GPG_PRIV }}
          passphrase: ${{ secrets.OSPO_BOT_GPG_PASS }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: true
      - name: Fetch all tags
        run: |
          echo "Fetching all tags to ensure we have tag objects..."
          git fetch --tags --force
      - name: Validate Tag Format
        if: ${{ github.ref_type == 'tag' }}
        run: bash .github-shared/scripts/validation/validate-tag-format.sh "${{ github.ref_name }}"
      - name: Validate Tag Signature
        if: ${{ github.ref_type == 'tag' }}
        env:
          OSPO_BOT_GPG_PUB: ${{ secrets.OSPO_BOT_GPG_PUB }}
        run: bash .github-shared/scripts/validation/validate-tag-signature.sh "${{ github.ref_name }}" "${{ github.repository }}" "$OSPO_BOT_GPG_PUB"
      - name: Validate Tag Uniqueness
        if: ${{ github.ref_type == 'tag' }}
        run: |
          echo "## Validating Tag Points to Unique Commit"
          TAG_NAME="${{ github.ref_name }}"

          # Get the commit SHA this tag points to
          TAG_COMMIT=$(git rev-parse "$TAG_NAME^{commit}")
          echo "Tag '$TAG_NAME' points to commit: $TAG_COMMIT"

          # Find all other tags pointing to the same commit
          OTHER_TAGS=$(git tag --points-at "$TAG_COMMIT" | grep -v "^${TAG_NAME}$" || true)

          if [ -n "$OTHER_TAGS" ]; then
            echo "::error::‚ùå Tag '$TAG_NAME' points to the same commit as other tag(s)"
            echo ""
            echo "The following tags also point to commit $TAG_COMMIT:"
            echo "$OTHER_TAGS" | sed 's/^/  - /'
            echo ""
            echo "üìù Multiple tags on the same commit cause changelog generation issues."
            echo "   This is a known limitation in git-cliff:"
            echo "   https://github.com/orhun/git-cliff/issues/1036"
            echo ""
            exit 1
          fi

          echo "‚úÖ Tag '$TAG_NAME' points to a unique commit"
          echo "‚úÖ No other tags found on commit $TAG_COMMIT"
      - name: Validate Tag Commit Availability
        if: ${{ github.ref_type == 'tag' }}
        run: bash .github-shared/scripts/validation/validate-tag-commit.sh "${{ github.ref_name }}" "${{ inputs.branch }}"
      # ============================================================================
      # SECTION 2: Authorization Validation
      # Checks if user is authorized for non-SNAPSHOT releases
      # ============================================================================
      - name: Check Release Authorization
        if: ${{ inputs.checkAuthorization }}
        run: |
          # Check if this is a SNAPSHOT release
          TAG_NAME="${{ github.ref_name }}"
          if [[ "${TAG_NAME}" == *-SNAPSHOT ]]; then
            echo "‚úÖ SNAPSHOT release - authorization check skipped"
            exit 0
          fi

          # For non-SNAPSHOT releases, check if actor is authorized
          AUTHORIZED_DEVS="${{ secrets.AUTHORIZED_RELEASE_DEVELOPERS }}"
          ACTOR="${{ github.actor }}"

          if [ -z "$AUTHORIZED_DEVS" ]; then
            echo "::warning::AUTHORIZED_RELEASE_DEVELOPERS secret not configured"
            echo "All users with tag push access can create releases"
            echo "‚úÖ Authorization check passed (no restrictions configured)"
            exit 0
          fi

          # Check if current actor is in the authorized list
          if echo ",$AUTHORIZED_DEVS," | grep -q ",$ACTOR,"; then
            echo "‚úÖ User '$ACTOR' is authorized to create production releases"
          else
            echo "::error::User '$ACTOR' is not authorized to create non-SNAPSHOT releases"
            echo "Only the following users can create production releases:"
            echo "$AUTHORIZED_DEVS" | tr ',' '\n' | sed 's/^/  - /'
            echo ""
            echo "If you need to create a release, please:"
            echo "1. Contact one of the authorized developers"
            echo "2. Or create a SNAPSHOT release instead (tag with -SNAPSHOT suffix)"
            exit 1
          fi
      # ============================================================================
      # SECTION 3: Secrets and Credentials Validation
      # Validates GPG keys, GitHub tokens, and publishing credentials
      # ============================================================================
      - name: Validate GPG Configuration
        if: ${{ inputs.signArtifacts }}
        id: gpg-test
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.OSPO_BOT_GPG_PRIV }}
          passphrase: ${{ secrets.OSPO_BOT_GPG_PASS }}
          git_user_signingkey: true
      - name: Validate GPG Public Key
        if: ${{ inputs.signArtifacts }}
        run: |
          if [ -z "${{ secrets.OSPO_BOT_GPG_PUB }}" ]; then
            echo "::error::Missing OSPO_BOT_GPG_PUB secret"
            echo "This secret is needed for GPG operations and signing"
            echo "Add it in Settings ‚Üí Secrets ‚Üí Actions"
            exit 1
          fi
          echo "‚úÖ GPG public key configured"
      - name: Validate GitHub Push Token
        run: |
          # OSPO_BOT_GHTOKEN is required for pushing version bumps
          if [ -z "${{ secrets.OSPO_BOT_GHTOKEN }}" ]; then
            echo "::error::Missing OSPO_BOT_GHTOKEN secret"
            echo "This token is required for:"
            echo "  - Pushing version bump commits"
            echo "  - Moving tags after version bump"
            echo "  - Pushing changelog updates"
            echo ""
            echo "Create a PAT with 'repo' scope and add as OSPO_BOT_GHTOKEN secret"
            exit 1
          fi

          # Test token validity and permissions
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.OSPO_BOT_GHTOKEN }}" \
            https://api.github.com/repos/${{ github.repository }})

          if [ "$RESPONSE" != "200" ]; then
            echo "::error::OSPO_BOT_GHTOKEN is invalid or lacks permissions"
            echo "HTTP Response: $RESPONSE"
            echo "Ensure the token has 'repo' scope"
            exit 1
          fi

          echo "‚úÖ GitHub push token validated"
      - name: Validate Release Token
        run: "# RELEASE_TOKEN is required for creating GitHub releases\nTOKEN=\"${{ secrets.RELEASE_TOKEN }}\"\nif [ -z \"$TOKEN\" ]; then\n  echo \"::error::Missing RELEASE_TOKEN secret\"\n  echo \"This token is required for creating GitHub releases\"\n  echo \"GITHUB_TOKEN cannot be used as it lacks permissions when workflows chain\"\n  echo \"Add it in Settings ‚Üí Secrets ‚Üí Actions\"\n  exit 1\nelse\n  # Test RELEASE_TOKEN\n  RESPONSE=$(curl -s -o /dev/null -w \"%{http_code}\" \\\n    -H \"Authorization: token $TOKEN\" \\\n    https://api.github.com/repos/${{ github.repository }}/releases)\n  \n  if [ \"$RESPONSE\" != \"200\" ]; then\n    echo \"::error::RELEASE_TOKEN is invalid or lacks permissions\"\n    exit 1\n  fi\n  echo \"‚úÖ Release token validated\"\nfi\n"
      - name: Validate Bot Token Permissions
        env:
          GH_TOKEN: ${{ secrets.OSPO_BOT_GHTOKEN }}
        run: |
          echo "Validating bot token permissions..."

          # Check if the bot token is available
          if [ -z "${{ secrets.OSPO_BOT_GHTOKEN }}" ]; then
            echo "::error::Cannot validate bot permissions without OSPO_BOT_GHTOKEN"
            exit 1
          fi

          # Test if token can authenticate (without revealing details)
          if ! gh api user --silent 2>/dev/null; then
            echo "::error::OSPO_BOT_GHTOKEN is invalid or expired"
            exit 1
          fi

          # Test if token has basic repository access (without revealing who/what permissions)
          if ! gh api repos/${{ github.repository }} --silent 2>/dev/null; then
            echo "::error::Bot token cannot access this repository"
            echo "Please ensure the bot has appropriate repository access"
            exit 1
          fi

          # Try to check for write permissions by querying branches (less revealing)
          if ! gh api repos/${{ github.repository }}/branches --silent 2>/dev/null; then
            echo "::warning::Bot token may have limited permissions"
            echo "Ensure the bot has sufficient permissions to:"
            echo "  - Push commits to branches"
            echo "  - Create and move tags"
            echo "  - Bypass branch protection (if enabled)"
          fi

          echo "‚úÖ Bot token is valid and has repository access"
      - name: Validate Maven Central Credentials
        if: ${{ inputs.artifactPublisher == 'maven-lib-mavencentral' }}
        run: |
          if [ -z "${{ secrets.MAVENCENTRAL_USERNAME }}" ]; then
            echo "::error::Missing MAVENCENTRAL_USERNAME secret"
            echo "Required for publishing to Maven Central"
            exit 1
          fi

          if [ -z "${{ secrets.MAVENCENTRAL_PASSWORD }}" ]; then
            echo "::error::Missing MAVENCENTRAL_PASSWORD secret"
            echo "Required for publishing to Maven Central"
            exit 1
          fi

          echo "‚úÖ Maven Central credentials configured"
      - name: Validate NPM Token
        if: ${{ inputs.artifactPublisher == 'npm-app-npmjs' }}
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "::error::Missing NPM_TOKEN secret"
            echo "Required for publishing to npmjs.org"
            echo "Generate token at https://www.npmjs.com/settings/~/tokens"
            exit 1
          fi

          echo "‚úÖ NPM token configured"
      # ============================================================================
      # SECTION 4: Summary Generation
      # Creates comprehensive validation report
      # ============================================================================
      - name: Generate Validation Summary
        if: always()
        run: "# Collect tag and commit information\nTAG_NAME=\"${{ github.ref_name }}\"\nCOMMIT_SHA=\"${{ github.sha }}\"\n\n# Get tag information if it's a tag\nif [ \"${{ github.ref_type }}\" = \"tag\" ]; then\n  TAGGER_INFO=$(git for-each-ref refs/tags/$TAG_NAME --format='%(taggername) <%(taggeremail)>' 2>/dev/null || echo \"N/A\")\n  TAG_DATE=$(git for-each-ref refs/tags/$TAG_NAME --format='%(taggerdate:short)' 2>/dev/null || echo \"N/A\")\n  TAG_MESSAGE=$(git tag -l -n1 \"$TAG_NAME\" | sed \"s/^$TAG_NAME *//\" | head -1 || echo \"No message\")\n  \n  # Check if tag is signed\n  TAG_SIGNATURE=\"Not signed\"\n  if git tag -v \"$TAG_NAME\" >/dev/null 2>&1; then\n    TAG_SIGNATURE=\"‚úÖ GPG signed\"\n  elif git show \"$TAG_NAME\" 2>/dev/null | grep -q \"BEGIN SSH SIGNATURE\"; then\n    TAG_SIGNATURE=\"‚úÖ SSH signed\"\n  fi\nfi\n\n# Get commit information\nCOMMIT_AUTHOR=$(git log -1 --format='%an <%ae>' $COMMIT_SHA)\nCOMMIT_DATE=$(git log -1 --format='%cs' $COMMIT_SHA)\nCOMMIT_MESSAGE=$(git log -1 --format='%s' $COMMIT_SHA)\n\n# Check if commit is signed\nCOMMIT_SIGNATURE=\"Not signed\"\nCOMMIT_CONTENT=$(git cat-file commit $COMMIT_SHA)\nif echo \"$COMMIT_CONTENT\" | grep -q \"BEGIN PGP SIGNATURE\"; then\n  COMMIT_SIGNATURE=\"‚úÖ GPG signed\"\nelif echo \"$COMMIT_CONTENT\" | grep -q \"BEGIN SSH SIGNATURE\"; then\n  COMMIT_SIGNATURE=\"‚úÖ SSH signed\"\nfi\n\ncat >> $GITHUB_STEP_SUMMARY << EOF\n# üìã Release Prerequisites Validation Report\n\n## üè∑Ô∏è Release Tag\n- **Tag:** \\`$TAG_NAME\\`\n- **Type:** ${{ github.ref_type }}\n- **Tagger:** $TAGGER_INFO\n- **Tag Date:** $TAG_DATE\n- **Tag Signature:** $TAG_SIGNATURE\n- **Tag Message:** $TAG_MESSAGE\n\n## üìù Tagged Commit\n- **SHA:** \\`$COMMIT_SHA\\`\n- **Author:** $COMMIT_AUTHOR\n- **Date:** $COMMIT_DATE\n- **Signature:** $COMMIT_SIGNATURE\n- **Message:** $COMMIT_MESSAGE\n\n## ‚öôÔ∏è Configuration\n| Setting | Value |\n|---------|-------|\n| **Project Type** | ${{ inputs.projectType }} |\n| **Artifact Publisher** | ${{ inputs.artifactPublisher }} |\n| **Container Registry** | ${{ inputs.containerRegistry }} |\n| **Release Publisher** | ${{ inputs.useJReleaser && '‚úÖ JReleaser' || '‚úÖ GitHub CLI' }} |\n| **GPG Signing** | ${{ inputs.signArtifacts && '‚úÖ Enabled' || '‚≠ï Disabled' }} |\nEOF\n\necho \"\" >> $GITHUB_STEP_SUMMARY\n\ncat >> $GITHUB_STEP_SUMMARY << 'EOF'\n## üîê Required Secrets Status\n\n| Secret | Purpose | Status |\n|--------|---------|--------|\nEOF\n\n# GPG signing (if enabled)\nif [ \"${{ inputs.signArtifacts }}\" = \"true\" ]; then\n  if [ -n \"${{ secrets.OSPO_BOT_GPG_PRIV }}\" ]; then\n    echo \"| OSPO_BOT_GPG_PRIV | Sign commits/artifacts | ‚úÖ Available |\" >> $GITHUB_STEP_SUMMARY\n    echo \"| OSPO_BOT_GPG_PASS | GPG passphrase | ‚úÖ Available |\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"| OSPO_BOT_GPG_PRIV | Sign commits/artifacts | ‚ùå Missing |\" >> $GITHUB_STEP_SUMMARY\n    echo \"| OSPO_BOT_GPG_PASS | GPG passphrase | ‚ùå Missing |\" >> $GITHUB_STEP_SUMMARY\n  fi\nfi\n\nif [ -n \"${{ secrets.OSPO_BOT_GHTOKEN }}\" ]; then\n  echo \"| OSPO_BOT_GHTOKEN | Push commits | ‚úÖ Available |\" >> $GITHUB_STEP_SUMMARY\n  \n  # Check bot token validity (without revealing permissions details)\n  BOT_STATUS=\"‚ùì Not verified\"\n  # Check if token can access the repository\n  if GH_TOKEN=\"${{ secrets.OSPO_BOT_GHTOKEN }}\" gh api repos/${{ github.repository }} --silent 2>/dev/null; then\n    BOT_STATUS=\"‚úÖ Valid token\"\n  else\n    BOT_STATUS=\"‚ùå Invalid/No access\"\n  fi\n  \n  echo \"| Bot Token Status | Repository access | $BOT_STATUS |\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"| OSPO_BOT_GHTOKEN | Push commits | ‚ùå Missing |\" >> $GITHUB_STEP_SUMMARY\n  echo \"| Bot Token Status | Repository access | ‚ùì No token |\" >> $GITHUB_STEP_SUMMARY\nfi\n\n# GPG Public Key (if signing enabled)\nif [ \"${{ inputs.signArtifacts }}\" = \"true\" ]; then\n  if [ -n \"${{ secrets.OSPO_BOT_GPG_PUB }}\" ]; then\n    echo \"| OSPO_BOT_GPG_PUB | GPG verification | ‚úÖ Available |\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"| OSPO_BOT_GPG_PUB | GPG verification | ‚ùå Required |\" >> $GITHUB_STEP_SUMMARY\n  fi\nfi\n\nif [ -n \"${{ secrets.RELEASE_TOKEN }}\" ]; then\n  echo \"| RELEASE_TOKEN | Create releases | ‚úÖ Available |\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"| RELEASE_TOKEN | Create releases | ‚ùå Required |\" >> $GITHUB_STEP_SUMMARY\nfi\n\n# Maven Central credentials (if maven-lib-mavencentral publisher)\nif [ \"${{ inputs.artifactPublisher }}\" = \"maven-lib-mavencentral\" ]; then\n  if [ -n \"${{ secrets.MAVENCENTRAL_USERNAME }}\" ]; then\n    echo \"| MAVENCENTRAL_USERNAME | Maven Central auth | ‚úÖ Available |\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"| MAVENCENTRAL_USERNAME | Maven Central auth | ‚ùå Missing |\" >> $GITHUB_STEP_SUMMARY\n  fi\n  \n  if [ -n \"${{ secrets.MAVENCENTRAL_PASSWORD }}\" ]; then\n    echo \"| MAVENCENTRAL_PASSWORD | Maven Central auth | ‚úÖ Available |\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"| MAVENCENTRAL_PASSWORD | Maven Central auth | ‚ùå Missing |\" >> $GITHUB_STEP_SUMMARY\n  fi\nfi\n\n# NPM token (only for npmjs.org publishing, not GitHub Packages)\nif [[ \"${{ inputs.artifactPublisher }}\" == \"npm-app-npmjs\" ]]; then\n  if [ -n \"${{ secrets.NPM_TOKEN }}\" ]; then\n    echo \"| NPM_TOKEN | NPM registry auth | ‚úÖ Available |\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"| NPM_TOKEN | NPM registry auth | ‚ùå Missing |\" >> $GITHUB_STEP_SUMMARY\n  fi\nfi\n\necho \"\"\nif [ \"${{ job.status }}\" = \"success\" ]; then\n  echo \"### ‚úÖ All required prerequisites are configured!\"\n  echo \"Ready to proceed with release üöÄ\"\nelse\n  echo \"### ‚ùå Prerequisites validation failed\" >> $GITHUB_STEP_SUMMARY\n  echo \"Please configure the missing secrets before attempting release\" >> $GITHUB_STEP_SUMMARY\nfi\n\n# Add validation checks summary\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"## ‚úîÔ∏è Validation Results\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"| Validation | Result | Details |\" >> $GITHUB_STEP_SUMMARY\necho \"|------------|--------|---------|\" >> $GITHUB_STEP_SUMMARY\n\n# Tag validations (if it's a tag)\nif [ \"${{ github.ref_type }}\" = \"tag\" ]; then\n  TAG_NAME=\"${{ github.ref_name }}\"\n  \n  # Semantic version check\n  if [[ \"$TAG_NAME\" =~ ^v[0-9]+\\.[0-9]+\\.[0-9]+ ]]; then\n    echo \"| Semantic Version | ‚úÖ Pass | \\`$TAG_NAME\\` follows vX.Y.Z |\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"| Semantic Version | ‚ùå Fail | Invalid format |\" >> $GITHUB_STEP_SUMMARY\n  fi\n  \n  # Tag type check\n  echo \"| Tag Type | ‚úÖ Pass | Annotated (not lightweight) |\" >> $GITHUB_STEP_SUMMARY\n  \n  # Signature check\n  echo \"| Tag Signature | ‚úÖ Pass | GPG/SSH signed |\" >> $GITHUB_STEP_SUMMARY\n  \n  # Pre-release detection\n  if [[ \"$TAG_NAME\" =~ -(alpha|beta|rc|snapshot|SNAPSHOT|dev) ]]; then\n    echo \"| Release Type | üîµ Pre-release | \\`${BASH_REMATCH[1]}\\` version |\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"| Release Type | üü¢ Stable | Production release |\" >> $GITHUB_STEP_SUMMARY\n  fi\nfi\n\n# Authorization check\nif [ \"${{ inputs.checkAuthorization }}\" = \"true\" ]; then\n  echo \"| User Authorization | ‚úÖ Pass | ${{ github.actor }} authorized |\" >> $GITHUB_STEP_SUMMARY\nelif [[ \"${{ github.ref_name }}\" =~ -SNAPSHOT$ ]]; then\n  echo \"| User Authorization | ‚è≠Ô∏è Skip | SNAPSHOT release |\" >> $GITHUB_STEP_SUMMARY\nfi\n\n# Token validations\nif [ -n \"${{ secrets.OSPO_BOT_GHTOKEN }}\" ]; then\n  echo \"| Push Token | ‚úÖ Pass | Valid GitHub token |\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"| Push Token | ‚ùå Fail | Missing OSPO_BOT_GHTOKEN |\" >> $GITHUB_STEP_SUMMARY\nfi\n\n# Publisher-specific checks\ncase \"${{ inputs.artifactPublisher }}\" in\n  maven-lib-mavencentral)\n    if [ -n \"${{ secrets.MAVENCENTRAL_USERNAME }}\" ]; then\n      echo \"| Maven Central | ‚úÖ Pass | Credentials configured |\" >> $GITHUB_STEP_SUMMARY\n    else\n      echo \"| Maven Central | ‚ùå Fail | Missing credentials |\" >> $GITHUB_STEP_SUMMARY\n    fi\n    ;;\n  npm-app-npmjs)\n    if [ -n \"${{ secrets.NPM_TOKEN }}\" ]; then\n      echo \"| NPM Registry | ‚úÖ Pass | Token configured |\" >> $GITHUB_STEP_SUMMARY\n    else\n      echo \"| NPM Registry | ‚ùå Fail | Missing NPM_TOKEN |\" >> $GITHUB_STEP_SUMMARY\n    fi\n    ;;\n  npm-app-github)\n    echo \"| NPM Registry | ‚úÖ Pass | Using GITHUB_TOKEN |\" >> $GITHUB_STEP_SUMMARY\n    ;;\nesac\n\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"---\" >> $GITHUB_STEP_SUMMARY\necho \"*Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*\" >> $GITHUB_STEP_SUMMARY"
